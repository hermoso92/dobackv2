generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  manager
  observer
}

enum UserStatus {
  active
  suspended
}

enum VehicleStatus {
  active
  maintenance
  inactive
}

enum VehicleType {
  truck
  van
  car
  other
}

enum SessionStatus {
  active
  completed
  error
}

enum SessionType {
  routine
  emergency
  maintenance
}

enum ReportType {
  stability
  telemetry
  ai
}

enum ReportStatus {
  pending
  ready
  failed
}

enum IngestStatus {
  pending
  processed
  failed
}

enum FileType {
  can
  gps
  stability
  rotator
}

model Organization {
  id         String   @id @default(uuid())
  name       String
  apiKey     String?  @map("api_key")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  users     User[]
  vehicles  Vehicle[]
  sessions  Session[]
  reports   Report[]
  settings  OrganizationSettings?
  fileIngests FileIngest[]
}

model OrganizationSettings {
  organization_id      String   @id
  report_schedule      String?
  notification_settings Json?
  stability_thresholds  Json?
  telemetry_thresholds  Json?
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
}

model User {
  id              String     @id @default(uuid())
  organization_id String
  email           String     @unique
  name            String?
  password_hash   String?
  role            UserRole   @default(manager)
  status          UserStatus @default(active)
  created_at      DateTime   @default(now())
  updated_at      DateTime   @updatedAt

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  sessions      Session[]
}

model Vehicle {
  id              String        @id @default(uuid())
  organization_id String
  identifier      String        @unique
  name            String?
  model           String?
  license_plate   String?
  type            VehicleType   @default(truck)
  status          VehicleStatus @default(active)
  park_id         String?
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  sessions      Session[]
  fileIngests   FileIngest[]
}

model Session {
  id              String        @id @default(uuid())
  organization_id String
  vehicle_id      String
  user_id         String?
  start_at        DateTime
  end_at          DateTime?
  sequence        Int?
  session_number  Int?
  status          SessionStatus @default(active)
  session_type    SessionType   @default(routine)
  source          String?
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  vehicle      Vehicle       @relation(fields: [vehicle_id], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [user_id], references: [id])
  telemetry_gps TelemetryGps[]
}

model TelemetryGps {
  id          String   @id @default(uuid())
  session_id  String
  recorded_at DateTime
  latitude    Float
  longitude   Float
  altitude    Float?
  speed       Float?
  satellites  Int?
  accuracy    Float?
  severity    Int?
  created_at  DateTime @default(now())

  session Session @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id, recorded_at], name: "telemetry_gps_session_recorded_idx")
}

model Report {
  id              String       @id @default(uuid())
  organization_id String
  requested_by    String?
  report_type     ReportType
  status          ReportStatus @default(pending)
  file_path       String?
  file_size       Int?
  sha256          String?
  expires_at      DateTime?
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
}

model FileIngest {
  id              String       @id @default(uuid())
  organization_id String
  vehicle_id      String?
  file_name       String
  file_hash       String?
  file_type       FileType
  status          IngestStatus @default(pending)
  metadata        Json?
  uploaded_at     DateTime     @default(now())
  processed_at    DateTime?

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  vehicle       Vehicle?     @relation(fields: [vehicle_id], references: [id])
}
