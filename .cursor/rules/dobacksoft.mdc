# ğŸ“ REGLAS CURSOR MEJORADAS â€“ PROYECTO DOBACKSOFT (StabilSafe V3)

## ğŸ­ ROL Y COMPORTAMIENTO

**ActÃºa como programador en pareja especializado en DobackSoft.**

- âœ… **Explica siempre quÃ© vas a hacer y por quÃ© antes de editar**
- âœ… **Respeta las reglas del producto: modularidad, roles fijos, flujo interno y diseÃ±o profesional**
- âœ… **NUNCA inicies backend/frontend automÃ¡ticamente** - el usuario los maneja con `iniciar.ps1`
- âœ… **Siempre usa `iniciar.ps1` como mÃ©todo de inicio Ãºnico** - no propongas otros scripts

## ğŸ› ï¸ CAMBIOS DE CÃ“DIGO

### **Reglas Estrictas:**
- âœ… **Un archivo por turno** - nunca mÃºltiples archivos simultÃ¡neamente
- âœ… **Un diff agrupado** - todas las modificaciones de ese archivo en un bloque
- âœ… **Formato obligatorio:**
  ```typescript
  // ... existing code ...
  // cambio aquÃ­
  // ... existing code ...
  ```
- âœ… **Antes de editar â†’ lee el contexto cercano** (imports, funciones relacionadas)
- âœ… **No insertar cÃ³digo basura ni hashes largos**
- âœ… **MÃ¡ximo 3 intentos por error** - si sigue fallando â†’ pide ayuda al usuario

### **Reglas de ConfiguraciÃ³n:**
- âœ… **NUNCA hardcodear URLs** - usar siempre `frontend/src/config/api.ts`
- âœ… **NUNCA usar console.log** - usar siempre `logger` de `utils/logger`
- âœ… **Siempre incluir filtro `organizationId`** en requests
- âœ… **Siempre usar TypeScript estricto** - no `any` sin justificaciÃ³n

## ğŸ’» COMANDOS Y PROCESOS

### **Reglas de Inicio:**
- âŒ **NUNCA iniciar backend/frontend** (ya corren en 2Âº plano)
- âœ… **Siempre proponer y pedir confirmaciÃ³n** antes de ejecutar comandos
- âœ… **AÃ±adir `| cat` en comandos de salida** (git log, head, less)
- âœ… **Procesos largos â†’ ejecutar en segundo plano**
- âœ… **Usar SIEMPRE `iniciar.ps1`** para inicio completo del sistema

### **Reglas de Puertos:**
- âœ… **Backend SIEMPRE en puerto 9998** - no cambiar nunca
- âœ… **Frontend SIEMPRE en puerto 5174** - no cambiar nunca
- âœ… **Si hay conflicto de puertos â†’ usar `iniciar.ps1`** que los libera automÃ¡ticamente
- âœ… **NUNCA sugerir cambiar puertos** - son fijos del proyecto

### **Reglas de Windows:**
- âœ… **Scripts PowerShell como `iniciar.ps1`** - no bash ni otros
- âœ… **Usar rutas Windows** (`\` no `/`)
- âœ… **Comandos compatibles con PowerShell**

## ğŸ“– BÃšSQUEDAS Y ANÃLISIS

### **Reglas de BÃºsqueda:**
- âœ… **Prefiere bÃºsqueda semÃ¡ntica** (ej. "GPS events", "auth middleware")
- âœ… **Usa grep solo si conoces el nombre exacto**
- âœ… **Lee bloques amplios, nunca lÃ­nea a lÃ­nea sin contexto**
- âœ… **Siempre analizar imports y dependencias** antes de modificar

### **Reglas de AnÃ¡lisis:**
- âœ… **Siempre verificar estructura de carpetas** antes de crear archivos
- âœ… **Leer documentaciÃ³n existente** antes de implementar
- âœ… **Verificar compatibilidad con reglas DobackSoft** antes de cambios

## ğŸ“ REGLAS ESPECÃFICAS DOBACKSOFT (StabilSafe V3)

### **1. MÃ³dulos Fijos en MenÃº (INMUTABLES)**
```
ğŸ  Panel de Control (nÃºcleo, KPIs + TV Wall)
ğŸ“Š Estabilidad
ğŸ“¡ TelemetrÃ­a (CAN/GPS)
ğŸ¤– Inteligencia Artificial
ğŸ—ºï¸ Geofences
ğŸ”§ Operaciones (Eventos + Alertas + Mantenimiento)
ğŸ“ˆ Reportes
âš™ï¸ AdministraciÃ³n (solo ADMIN)
ğŸ“š Base de Conocimiento (solo ADMIN)
ğŸ‘¤ Mi Cuenta
```

### **2. DiseÃ±o Obligatorio**
- âœ… **KPIs estratÃ©gicos dominan el Panel** (TV Wall automÃ¡tico)
- âœ… **Scroll permitido cuando sea necesario** (listas, mapas, dashboards grandes)
- âœ… **Layout modular con tarjetas + subpÃ¡ginas**
- âœ… **Framework: React + Tailwind** (UI limpia, profesional)
- âœ… **Mapas: Leaflet + TomTom obligatorios**

### **3. Panel de Control**
- âœ… **KPIs = protagonistas absolutos** (disponibilidad, tiempos, rotativo, incidencias, km, costes)
- âœ… **Modo TV Wall â†’ KPIs grandes, colores, sin menÃºs**
- âœ… **Bloques secundarios: mantenimiento, alertas, tendencias**
- âœ… **Emergencias NO es mÃ³dulo** â†’ la info se refleja en KPIs

### **4. Estabilidad**
- âœ… **MÃ©tricas principales:**
  - Horas de conducciÃ³n
  - Km recorridos
  - Tiempo con rotativo encendido (clave 2 / clave 5)
  - NÃºmero de incidencias (leves, graves, crÃ­ticas)
  - Eventos crÃ­ticos detectados
- âœ… **VisualizaciÃ³n: grÃ¡ficas interactivas, mapa de eventos GPS, colores por severidad**
- âœ… **Comparador: solo entre sesiones de estabilidad** (vehÃ­culos, turnos o dÃ­as)
- âœ… **ExportaciÃ³n: PDF en 1 clic** con mÃ©tricas, grÃ¡ficas, mapa y anÃ¡lisis IA

### **5. TelemetrÃ­a**
- âœ… **CAN + GPS juntos, separados de Estabilidad**
- âœ… **Un solo mÃ³dulo con pestaÃ±as internas:**
  - ğŸ“¡ Datos CAN
  - ğŸ—ºï¸ Mapa GPS
  - ğŸ”” Alarmas configurables
  - ğŸ“Š Comparador CAN/GPS
- âœ… **Alarmas: umbrales configurables por variable**
- âœ… **Mapas con puntos GPS coloreados segÃºn evento**

### **6. Inteligencia Artificial**
- âœ… **Un solo mÃ³dulo tipo copiloto con pestaÃ±as:**
  - Chat IA
  - Patrones detectados
  - Recomendaciones
- âœ… **IA genera reportes PDF automÃ¡ticos**
- âœ… **Sugerencias explicadas, no solo valores**

### **7. Geofences**
- âœ… **CRUD completo de zonas**
- âœ… **Eventos: entrada/salida, tiempo dentro, violaciones**
- âœ… **IntegraciÃ³n directa en mapa de TelemetrÃ­a**
- âœ… **Alertas automÃ¡ticas ligadas a geofences**

### **8. Operaciones**
- âœ… **Unifica Eventos, Alertas y Mantenimiento**
- âœ… **Alertas con severidad, reglas configurables y notificaciones** (push/email)
- âœ… **Mantenimiento: preventivo, correctivo, predictivo**
- âœ… **Vista en calendario + historial de tareas**

### **9. Subida de Archivos**
- âœ… **VÃ­a formulario o FTP**
- âœ… **Siempre extraer ID de archivo**
- âœ… **Si vehÃ­culo no existe â†’ ofrecer crearlo automÃ¡ticamente**
- âœ… **Asociar a sesiÃ³n por dÃ­a/hora/ID**
- âœ… **Mostrar errores claros** (sin ID, duplicados, corruptos)

### **10. ExportaciÃ³n**
- âœ… **PDF en 1 clic desde:**
  - Panel
  - Sesiones
  - IA
  - Comparadores
- âœ… **PDFs incluyen mÃ©tricas, grÃ¡ficas y anÃ¡lisis IA**

### **11. Roles**
- âœ… **ADMIN: acceso total**
- âœ… **MANAGER: solo su empresa y flota**
- âœ… **No existen otros roles**

### **12. Flujo Interno Obligatorio**
- âœ… **Subida â†’ Procesamiento automÃ¡tico â†’ VisualizaciÃ³n â†’ ComparaciÃ³n â†’ ExportaciÃ³n**

## ğŸ”§ REGLAS TÃ‰CNICAS MEJORADAS

### **ConfiguraciÃ³n de API:**
- âœ… **Usar SIEMPRE `frontend/src/config/api.ts`** para endpoints
- âœ… **Headers con `organizationId`** en todos los requests
- âœ… **Variables de entorno** para URLs (no hardcodeadas)
- âœ… **Timeout configurable** para requests

### **Logging y Debugging:**
- âœ… **NUNCA usar `console.log`** - usar `logger` de `utils/logger`
- âœ… **Logging con niveles** (`info`, `error`, `warn`, `debug`)
- âœ… **Captura de errores** con contexto apropiado

### **Seguridad:**
- âœ… **Cookies httpOnly** para JWT
- âœ… **ProtecciÃ³n CSRF** implementada
- âœ… **S3 presigned URLs cifradas** (SSE-KMS)
- âœ… **Filtrado por organizaciÃ³n** en todos los datos

### **Performance:**
- âœ… **Lazy loading** para componentes pesados
- âœ… **Tree-shaking** optimizado en imports
- âœ… **Componentes <300 lÃ­neas**
- âœ… **Bundle size <300 KB** sin justificar

## âœ… CHECKLIST RÃPIDA POR CADA CAMBIO

### **Verificaciones Obligatorias:**
- [ ] Â¿Respeta modularidad?
- [ ] Â¿El mÃ³dulo estÃ¡ en el menÃº oficial V3?
- [ ] Â¿Scroll solo donde es necesario?
- [ ] Â¿Comparadores correctos (solo Estabilidad o solo CAN/GPS)?
- [ ] Â¿Roles aplicados (ADMIN/MANAGER)?
- [ ] Â¿Flujo Subidaâ†’ExportaciÃ³n respetado?
- [ ] Â¿ExportaciÃ³n PDF en 1 clic disponible?
- [ ] Â¿Usa `config/api.ts` en lugar de URLs hardcodeadas?
- [ ] Â¿Usa `logger` en lugar de `console.log`?
- [ ] Â¿Incluye filtro `organizationId`?
- [ ] Â¿Compatible con `iniciar.ps1`?

## ğŸš¨ REGLAS CRÃTICAS (NO VIOLAR NUNCA)

1. **NUNCA iniciar backend/frontend** - usar `iniciar.ps1`
2. **NUNCA hardcodear URLs** - usar `config/api.ts`
3. **NUNCA usar console.log** - usar `logger`
4. **NUNCA cambiar puertos** - 9998 backend, 5174 frontend
5. **NUNCA crear mÃ³dulos fuera del menÃº oficial**
6. **NUNCA exponer datos entre organizaciones**
7. **NUNCA usar dependencias >300 KB sin justificar**

## ğŸ“‹ REGLAS DE INICIO DEL SISTEMA

### **MÃ©todo Ãšnico: `iniciar.ps1`**
- âœ… **Script Ãºnico y oficial** para iniciar todo el sistema
- âœ… **Libera puertos automÃ¡ticamente** (9998, 5174)
- âœ… **Verifica archivos necesarios** antes de iniciar
- âœ… **Inicia backend y frontend** en ventanas separadas
- âœ… **Verifica que ambos servicios funcionen** antes de continuar
- âœ… **Abre navegador automÃ¡ticamente**
- âœ… **Muestra credenciales de login**

### **Problemas Comunes Resueltos:**
- âœ… **Conflicto de puertos** â†’ `iniciar.ps1` los libera automÃ¡ticamente
- âœ… **Frontend se cierra al reiniciar backend** â†’ `iniciar.ps1` los inicia independientemente
- âœ… **Puertos incorrectos** â†’ `iniciar.ps1` usa puertos fijos (9998, 5174)
- âœ… **Archivos faltantes** â†’ `iniciar.ps1` verifica antes de iniciar

---

**ESTAS REGLAS SON OBLIGATORIAS Y NO NEGOCIABLES**
**CUALQUIER VIOLACIÃ“N REQUIERE CORRECCIÃ“N INMEDIATA**
