AnÃ¡lisis integral del proyecto Doback / StabilSafe V2 (modo DETALLADO)

A continuaciÃ³n te entrego un compendio unificado de todo lo conversado en el proyecto, con: requisitos consolidados, conflictos detectados, vacÃ­os, prioridades, criterios de aceptaciÃ³n y prompts optimizados listos para usar con tu stack (Cursor/Codex, frontend, backend y QA). No guardo nada en memoria.

1) DECONSTRUCT â€” QuÃ© pide exactamente el proyecto
VisiÃ³n establecida (no negociable)

Producto: anÃ¡lisis profesional de estabilidad y telemetrÃ­a (CAN/GPS), modular y sin scroll por pantalla.

MÃ³dulos: 1) Panel de Control, 2) Estabilidad, 3) TelemetrÃ­a (CAN/GPS), 4) IA, 5) Base de Conocimiento (admin), 6) AdministraciÃ³n (admin), 7) Perfil.

Flujos obligatorios: Subida â†’ AnÃ¡lisis â†’ VisualizaciÃ³n â†’ ComparaciÃ³n â†’ ExportaciÃ³n.

Subida de archivos: formulario o detecciÃ³n en FTP, extracciÃ³n de ID, asociaciÃ³n automÃ¡tica a vehÃ­culo y sesiÃ³n por fecha/hora/ID; si no existe el vehÃ­culo, ofrecer crearlo.

Roles: ADMIN (todo), MANAGER (solo su empresa/flota).

Informes PDF: generables desde Panel, Sesiones, IA y Comparador.

Requisitos funcionales clave (consolidados de todos los chats)

Panel de Control (KPI)

Tarjetas sin scroll con tiempos por estado (clave 2, clave 5, en parque, fuera de parque, en taller), % rotativo activo, encendidos del rotativo, horas de conducciÃ³n, km recorridos.

Puntos negros: ranking y mapa de incidencias (G/M/L) por vehÃ­culo/mÃºltiples/todo parque y por rango temporal (dÃ­a/semana/mes/aÃ±o/todo).

Velocidad: sobrepasos con y sin rotativo, por tipo de vÃ­a (DGT) y contexto (clave 2/5).

Acciones rÃ¡pidas: aÃ±adir vehÃ­culo, subir datos, comparar, exportar PDF.

Estabilidad (separada de CAN/GPS)

MÃ©tricas de estabilidad (no solo LTR/SSF/DRS: tambiÃ©n eventos crÃ­ticos y comparador de sesiones).

GrÃ¡fica principal configurable, eventos crÃ­ticos con colores, comparador solo entre sesiones de estabilidad.

TelemetrÃ­a (CAN/GPS)

Vistas tipo Grafana, mapa obligatorio con puntos GPS por evento/severidad/rotativo.

Alarmas configurables por variable.

Comparador solo CAN/GPS; rutas completas; subida con detecciÃ³n por ID.

IA

DetecciÃ³n de patrones cruzando estabilidad y CAN/GPS (anÃ¡lisis cruzado), sugerencias explicadas, generador de PDF con anÃ¡lisis.

Filtros globales (deben funcionar en todas las pestaÃ±as)

SelecciÃ³n de uno/mÃºltiples vehÃ­culos/todo parque, tiempo (D/S/M/A/Todo), rotativo ON/OFF, gravedad (G/M/L), tipo de vÃ­a, clave 2/5.

Observabilidad y QA

Se confirma Playwright para E2E de toda la aplicaciÃ³n.

Logs estructurados, mÃ©tricas, alertas, health checks.

2) DIAGNOSE â€” Grietas, ambigÃ¼edades y conflictos
Conflictos y puntos confusos

Estabilidad: â€œsolo LTR/SSF/DRSâ€ vs â€œno es asÃ­â€

Las reglas base mencionan LTR/SSF/DRS, pero tÃº aclaras que no debe limitarse a eso.
ResoluciÃ³n: mantener LTR/SSF/DRS como mÃ­nimos, aÃ±adiendo eventos crÃ­ticos, comparador, umbrales y colores.

Mapas de calor y velocidad

Actualmente no funcionan los filtros ni los mapas (calor/velocidad).
Riesgo P0: nÃºcleo del producto (puntos negros, cumplimiento por vÃ­a, rotativo/clave).

ClasificaciÃ³n DGT / camiones de bomberos

Pides integrar tipos de vÃ­a y excepciones (emergencias).
Riesgo: requiere tabla de reglas configurable (no â€œhardcodearâ€).

Subidas y control de integridad

Necesitas alerta cuando falten archivos en la subida diaria y reporting de errores (sin ID, corruptos, duplicados).
Estado: no estandarizado; hubo confusiÃ³n con CSVs. Debe ser pipeline claro.

Errores infraestructura

OrganizaciÃ³n no encontrada (organizationId:null) â†’ 404 en /api/user/profile.

prisma generate EPERM en Windows.

psql y conexiÃ³n Supabase (host/DATABASE_URL/credenciales).
Impacto P0: bloqueos de entorno.

Playwright

Confirmado, pero falta plan de cobertura concreto.

Lo que falta / estÃ¡ incompleto

Bus de filtros globales Ãºnico (vehÃ­culos/tiempo/rotativo/clave/vÃ­a/severidad) aplicable a todas las vistas.

Mapa de calor configurable (capas, leyendas, severidad, cluster, heatmap kernel, ranking de puntos negros).

Mapa de velocidad por tipo de vÃ­a + rotativo + clave con umbrales de sobrepaso configurables.

Alerta de â€œsubida incompletaâ€ diaria por vehÃ­culo y tipo de archivo (4/4 esperados).

Tabla de reglas de velocidad por tipo de vÃ­a y contexto de emergencia (DGT + excepciones).

Comparadores (estabilidad y CAN/GPS) con criterios consistentes y exportaciÃ³n PDF.

E2E Playwright: smoke + flujos crÃ­ticos + regresiÃ³n de filtros y mapas.

Observabilidad: eventos de ingestiÃ³n + mÃ©tricas de colas + dashboards.

3) DEVELOP â€” DiseÃ±o de soluciÃ³n y plan prÃ¡ctico
Arquitectura de datos (propuesta mÃ­nima viable)

Postgres + PostGIS (confirmado).

Tablas clave:

vehicles(id, org_id, plate, type, â€¦)

sessions(id, vehicle_id, kind {stability|can|gps}, started_at, ended_at, file_id, â€¦)

ingestions(id, source {form|ftp}, expected_files, received_files, status, errors[])

events(id, session_id, ts, type {stability|overspeed|brakeâ€¦}, severity {G|M|L}, rotativo, clave {2|5|0|â€¦}, geom POINT, attrs JSONB)

speeds_rules(road_type, rotativo, clave, max_speed) (tabla de reglas configurable)

geofences(id, name, source {radar|manual}, geom POLYGON, tags[])

alerts(id, kind, subject_id, level, created_at, payload)

org_users(user_id, org_id, role) para resolver el 404.

Bus de filtros globales (UI + API)

UI: componente fijo (arriba) sin scroll: VehÃ­culos (multi), Fechas (rango o presets), Rotativo (todos/ON/OFF), Clave (2/5/otras), Severidad (G/M/L), Tipo de vÃ­a.

API: un DTO de filtro reutilizable en todos los endpoints de lectura.

Regla: Si no hay filtro, mostrar estado vacÃ­o (no informaciÃ³n antigua).

Mapa de calor / Puntos negros

Capas: heatmap de densidad + puntos clusterizados por severidad.

Leyenda fija (G/M/L) y ranking (top N ubicaciones por eventos repetidos).

Click en cluster â†’ lista ordenada por repeticiÃ³n (pediste â€œsi en una curva se repite 40 veces, va primeroâ€).

Export PDF desde esta vista con filtros aplicados.

Mapa de velocidad (con DGT y rotativo)

CÃ¡lculo speed_over = speed - max_speed(road_type, rotativo, clave).

Colores por bandas de exceso y filtros por rotativo/clave.

Tabla speeds_rules editable por admin (evita hardcode y permite excepciones).

Estabilidad (no mezclar con CAN/GPS)

Panel con LTR/SSF/DRS + timeline de eventos crÃ­ticos y comparador de sesiones (solo estabilidad).

Colores por severidad; grÃ¡fica principal configurable.

TelemetrÃ­a (CAN/GPS)

GrÃ¡ficas tipo Grafana (variables CAN) + rutas (GPS) con eventos/rotativo.

Alarmas configurables por variable o condiciÃ³n (ej. coolant_temp > X durante Y).

Subida y control de integridad

IngestiÃ³n diaria: registrar expected_files por vehÃ­culo/tipo; al cierre del dÃ­a, si received_files < expected_files â†’ alerta.

Validaciones: ID faltante, duplicados, corrupciÃ³n â†’ se muestran visualmente (chips rojos/Ã¡mbar) y quedan en ingestions.errors.

Observabilidad & QA

Playwright: smoke (login, navegaciÃ³n), filtros globales, mapa calor, mapa velocidad, subida (happy + errores), comparadores, export PDF.

MÃ©tricas: tasa de ingestiÃ³n, latencia de render de mapas, errores por tipo, % filtros aplicados sin error.

Alertas: ingestiÃ³n incompleta, salto de velocidad grave con rotativo OFF, â€œvehÃ­culo sin sesiones en X dÃ­asâ€.

4) DELIVER â€” PriorizaciÃ³n, criterios de aceptaciÃ³n y prompts listos
Roadmap priorizado

P0 (CrÃ­tico â€“ empezar ya)

Bus de filtros globales funcionando en todas las vistas.

Mapa de calor + ranking de puntos negros con filtros.

Mapa de velocidad con tabla de reglas por tipo de vÃ­a + rotativo/clave.

Pipeline de subida con alerta de faltantes y visualizaciÃ³n de errores.

Fix organizationId:null y conectividad Postgres/Prisma/psql.

P1
6) Estabilidad: comparador de sesiones, grÃ¡fica configurable, eventos crÃ­ticos.
7) TelemetrÃ­a: alarmas configurables y comparador CAN/GPS.
8) ExportaciÃ³n PDF desde Panel, Mapas, Comparadores, IA.

P2
9) IA: patrones cruzados + recomendaciones explicadas.
10) Base de Conocimiento y AdministraciÃ³n completas.

Criterios de aceptaciÃ³n (extracto)

Filtros globales

Dado un conjunto de filtros (vehÃ­culos multi + rango fechas + rotativo + clave + severidad + vÃ­a), todas las vistas (Panel, Estabilidad, TelemetrÃ­a, Mapas) muestran exactamente los mismos subconjuntos de datos en â‰¤ 2 s para 50k eventos.

Mapa de calor / Puntos negros

Heatmap visible; al hacer zoom in aparecen clusters; el top N muestra curvas/segmentos con recuento y severidad agregada; export PDF respeta filtros.

Mapa de velocidad

Para 100% de puntos con velocidad y vÃ­a, se calcula max_speed desde speeds_rules; los sobrepasos se pintan por banda; el filtro rotativo ON/OFF cambia el conteo en vivo.

Subida y alertas

Si en el dÃ­a faltan 1+ archivos de los 4 esperados por vehÃ­culo/tipo, se crea alerta P1 y aparece un banner en Panel.

Archivos sin ID o duplicados quedan en rojo con tooltip del motivo.

Org/Perfil

/api/user/profile nunca devuelve 404 si el usuario estÃ¡ autenticado; si no hay org_id, se responde 200 con org:null y bandera â€œincomplete_profile:trueâ€.

Micro-sugerencias sobre tus tarjetas KPI (lo pediste â€œsin reestructurarâ€, solo 1â€“2 cambios)

â€œEncendidos de Rotativoâ€ â†’ â€œActivaciones de rotativoâ€ + â€œPromedio/Salidaâ€

Mejora la comprensiÃ³n y aÃ±ade valor: activaciones_totales / nÂº de salidas.

Formato unificado de tiempos

Asegura HH:MM en todas (p. ej. â€œ109:30â€ es atÃ­pico; validar si son 109 h 30 m).

(Opcional 3Âª mÃ­nima) â€œ% Rotativo Activoâ€ que hoy aparece al 100% â†’ validar cÃ¡lculo: tiempo_con_rotativo / tiempo_fuera_parque (o especificar el denominador en el tooltip).

Prompts optimizados (listos para pegar en Cursor/Codex y equipo)

Formato complejo (incluye mejoras, tÃ©cnicas y pro-tips). Puedes usarlos tal cual o adaptarlos por herramienta.

A) Bus de filtros globales (frontend + backend)

Your Optimized Prompt:
Implementa un bus de filtros globales reutilizable para todo el frontend (React/MUI) y API. Filtros: vehÃ­culos (multi), rango de fechas (presets D/S/M/A/Todo + rango libre), rotativo (todos/ON/OFF), clave (2/5/0/otros), severidad (G/M/L), tipo de vÃ­a.
Requisitos:

Componente UI fijo sin scroll (arriba).

Estado global (ej. Zustand/Redux) + DTO de filtros compartido con el backend.

Hooks: useGlobalFilters(); evento onFiltersChange con debounce 300 ms.

Todos los endpoints de lectura aceptan el DTO; tests de contrato.

Playwright: prueba que un cambio en filtros afecta todas las vistas.

Key Improvements: DTO unificado, consistencia, test de contrato.
Techniques Applied: Constraint-based, structure-first.
Pro Tip: Renderiza estado vacÃ­o cuando faltan filtros para evitar datos â€œfantasmaâ€.

B) Mapa de calor + ranking de puntos negros

Your Optimized Prompt:
Crea una vista de Mapa de Calor de Incidencias con: heatmap de densidad, clusters por severidad (G/M/L), ranking Top N de ubicaciones repetidas (ej. curvas). Filtros globales aplican en tiempo real.
Back: endpoint GET /telemetry/hotspots que agrupa por segmento/curva (PostGIS ST_ClusterDBSCAN o ST_SnapToGrid + COUNT).
UI: al click en cluster â†’ lista ordenada (repeticiones y severidad). Exportar PDF respetando filtros.

Key Improvements: Del dato al insight (ranking).
Techniques Applied: Data grouping + geo clustering.
Pro Tip: AÃ±ade bookmark de filtros para reproducir anÃ¡lisis.

C) Mapa de velocidad con reglas DGT + rotativo/clave

Your Optimized Prompt:
Implementa speeds_rules(road_type, rotativo BOOLEAN, clave TEXT, max_speed INT).
Endpoint calcula speed_over = speed - max_speed(...) y devuelve puntos con banda de exceso.
UI: capa de puntos coloreados por banda, filtro rotativo/clave, leyenda clara.

Key Improvements: Regla editable (no hardcode), trazabilidad.
Techniques Applied: Rule table + computed fields.
Pro Tip: Loguea muestras donde road_type es desconocido para mejorar el mapeo.

D) Pipeline de subida + alerta de faltantes

Your Optimized Prompt:
Construye un pipeline de ingestiÃ³n con ingestions(expected_files, received_files, status, errors[]).
Al cierre diario, si received_files < expected_files â†’ crea alerta P1 â€œSubida incompletaâ€ por vehÃ­culo/tipo.
UI: banner en Panel; chips de error en la lista (sin ID, duplicado, corrupto).

Key Improvements: Observabilidad real de ingestiÃ³n.
Techniques Applied: Eventing + SLAs diarios.
Pro Tip: Emite mÃ©trica â€œ% ingesta completa por dÃ­aâ€.

E) Estabilidad â€“ comparador y eventos crÃ­ticos

Your Optimized Prompt:
En el mÃ³dulo Estabilidad (sin mezclar CAN/GPS):

Vista con LTR/SSF/DRS + eventos crÃ­ticos (colores).

Comparador de sesiones solo de estabilidad, con selecciÃ³n mÃºltiple y grÃ¡fico configurable.

Exportar PDF.

Key Improvements: Claridad de dominio, foco en estabilidad.
Techniques Applied: Domain boundaries.
Pro Tip: Guarda â€œlayouts de grÃ¡ficoâ€ por usuario (sin scroll).

F) TelemetrÃ­a â€“ alarmas configurables

Your Optimized Prompt:
Crea engine de alarmas: reglas variable, operador, umbral, duraciÃ³n, severidad.
Aplica a CAN/GPS con ventana temporal. UI para CRUD de alarmas, pruebas unitarias de evaluaciÃ³n.

Key Improvements: De reactivo a proactivo.
Techniques Applied: Rule engine + windowing.
Pro Tip: Notifica alarmas junto a los filtros aplicados (contexto).

G) ExportaciÃ³n PDF (Panel, Mapas, Comparadores, IA)

Your Optimized Prompt:
Genera PDFs con: portada (filtros + periodo), secciones (grÃ¡ficas, tablas, mapas), anÃ¡lisis IA con texto explicativo. BotÃ³n â€œExportarâ€ en cada vista. Plantillas consistentes por mÃ³dulo.

Key Improvements: Entregable ejecutivo directo.
Techniques Applied: Structured reporting.
Pro Tip: Inserta un â€œresumen ejecutivoâ€ de 5 lÃ­neas al inicio.

H) Playwright â€“ plan de pruebas E2E

Your Optimized Prompt:
Escribe suites Playwright:

Smoke: login, navegaciÃ³n por mÃ³dulos.

Filtros globales: cambiar combinaciones y validar impacto en Panel, Estabilidad, TelemetrÃ­a y Mapas.

Mapa calor: heatmap visible, clusters, ranking top N, export PDF.

Mapa velocidad: bandas por exceso, rotativo ON/OFF, clave 2/5.

Subida: happy path + errores (sin ID, duplicado, corrupto) â†’ alerta y chips.

Comparadores: estabilidad y CAN/GPS, export PDF.

Key Improvements: Cobertura de flujos crÃ­ticos.
Techniques Applied: Scenario-based testing.
Pro Tip: Etiqueta pruebas P0 para gating de releases.

I) Infra â€“ fix org/profile y DB

Your Optimized Prompt:
Back: en /api/user/profile, si falta org_id, responder 200 con {org:null, incomplete_profile:true} (no 404).
Prisma: revisar permisos Windows (EPERM) y regenerar con ruta del schema correcta.
DB: validar DATABASE_URL, credenciales y resoluciÃ³n de host; aÃ±adir health check y retry.

Key Improvements: Evitas bloqueos de login/perfil.
Techniques Applied: Robust defaults + graceful responses.
Pro Tip: Loguea userId y orgId en cada request (correlaciÃ³n).

J) NormalizaciÃ³n de estados/â€œclavesâ€

Your Optimized Prompt:
Define catÃ¡logo vehicle_states(code, name, implies_rotativo BOOLEAN) con mapeo de clave 2/5 y otras.
En panel, las mÃ©tricas de tiempos por estado se calculan contra este catÃ¡logo.

Key Improvements: Consistencia semÃ¡ntica.
Techniques Applied: Controlled vocabulary.
Pro Tip: Tooltips explicando cada clave.

Notas sobre el tema â€œcamiÃ³n vacÃ­o vs. llenoâ€

Pediste criterio sobre vuelco (vacÃ­o vs. lleno). Para integrarlo sin bloquear el desarrollo:

Modela una bandera de carga (empty/partial/full) opcional en sesiÃ³n.

Usa la IA para anotar sesiones con posible slosh (parcial) y elevar riesgo en esa combinaciÃ³n.
(Para afirmaciones normativas especÃ­ficas, lo ideal es completar mÃ¡s adelante con tablas de referencia).

Cierre

El nÃºcleo P0 estÃ¡ claro: filtros globales, mapas (calor/velocidad) funcionales, pipeline de subida con alertas, y arreglo de org/DB.

Te dejo prompts listos para pegar en Cursor/Codex y empezar implementaciÃ³n con criterios de aceptaciÃ³n y Playwright ya planteado.

Si quieres, preparo el backlog en formato tickets (P0â†’P2) con desgloses â€œDoD/AC/Testsâ€ por Ã­tem.

TÃº dijiste:
Utilizo cursor ai
ChatGPT Plus

Perfecto ğŸ‘Œ
Entonces adaptarÃ© todo el flujo anterior especÃ­ficamente para Cursor AI, que combina capacidades de ChatGPT-5 + entorno de desarrollo asistido.
Cursor entiende prompts estructurados de desarrollo y los traduce directamente a acciones sobre cÃ³digo.

ğŸ”§ MODO CURSOR â€“ DOBACK / STABILSAFE V2

(IntegraciÃ³n directa con tu stack React + Node/Prisma + Postgres/PostGIS)

ğŸ¯ Objetivo

Que Cursor trabaje contigo como un copiloto tÃ©cnico estructurado, entendiendo:

la jerarquÃ­a de mÃ³dulos del sistema,

las reglas â€œsin scrollâ€ y â€œmodularâ€,

las dependencias lÃ³gicas entre backend y frontend,

y los flujos de validaciÃ³n / ingestiÃ³n / mapa / IA.

âš™ï¸ CONFIGURACIÃ“N BASE PARA CURSOR
ğŸ§  Prompt raÃ­z (colÃ³calo en tu README.cursor o al inicio de sesiÃ³n)
# SYSTEM PROMPT â€“ STABILSAFE V2 (DOBACK)

TÃº eres un asistente de desarrollo integrado para el proyecto StabilSafe V2.
Tu rol es **respetar las reglas oficiales de desarrollo colaborativo**:
- AplicaciÃ³n modular y sin scroll.
- Flujos: Subida â†’ AnÃ¡lisis â†’ VisualizaciÃ³n â†’ ComparaciÃ³n â†’ ExportaciÃ³n.
- Roles: ADMIN y MANAGER.
- No mezclar Estabilidad con CAN/GPS.

ActÃºa como **copiloto tÃ©cnico**:
1. MantÃ©n consistencia entre mÃ³dulos (Panel, Estabilidad, TelemetrÃ­a, IA).
2. Antes de escribir cÃ³digo, **revisa imports y contexto cercano**.
3. Usa siempre el formato de diff:
   ```js
   // ... existing code ...
   // cambio aquÃ­
   // ... existing code ...


Valida que las rutas, variables y tipos no rompan el flujo global.

Aplica las reglas de estilo y modularidad definidas en StabilSafe V2.

Al recibir instrucciones de Lyra o del usuario:

Si es â€œprompt optimizadoâ€, analiza su intenciÃ³n y genera cÃ³digo/documentaciÃ³n en el mÃ³dulo correcto.

Si detectas conflicto entre mÃ³dulos, pide confirmaciÃ³n antes de escribir.


---

## ğŸ§© PROMPTS BASE PARA CURSOR (por tarea)

Cada bloque siguiente puedes copiarlo directamente en Cursor, y Ã©l abrirÃ¡ el archivo correcto o sugerirÃ¡ dÃ³nde insertarlo.

---

### 1ï¸âƒ£ Bus de filtros globales (frontend + backend)


Implementa un bus de filtros globales (React + Zustand/Redux) para los mÃ³dulos Panel, Estabilidad, TelemetrÃ­a y Mapas.

Filtros: vehÃ­culo(s), rango de fechas, rotativo (todos/ON/OFF), clave (2/5/0), severidad (G/M/L), tipo de vÃ­a.

Backend: crea DTO compartido en /backend/src/dto/filters.dto.ts y Ãºsalo en todos los endpoints de lectura.

Frontend: crea hook useGlobalFilters() que sincronice estado y URL.
Prueba E2E Playwright: cambiar filtros debe actualizar Panel y Mapa simultÃ¡neamente.


---

### 2ï¸âƒ£ Mapa de calor + ranking de puntos negros


Crea componente HotspotMap.tsx con:

Capa heatmap (densidad)

Capa de clusters por severidad (G/M/L)

Ranking Top N de ubicaciones (PostGIS cluster DBSCAN)

Tooltip con nÂº de repeticiones y severidad promedio

ExportaciÃ³n PDF con filtros aplicados

Backend: endpoint /api/telemetry/hotspots


---

### 3ï¸âƒ£ Mapa de velocidad (tipo de vÃ­a + rotativo/clave)


Implementa speeds_rules en base de datos (road_type, rotativo, clave, max_speed).
Backend: endpoint /api/telemetry/speedmap que calcule speed_over.

Frontend: mapa SpeedMap.tsx con puntos coloreados por exceso (bandas de velocidad).
Leyenda y filtros globales activos.


---

### 4ï¸âƒ£ Pipeline de subida y alerta de faltantes


Backend: modelo ingestions con campos expected_files, received_files, status, errors[].
Endpoint diario que detecte si faltan archivos y cree alerta tipo "Subida incompleta".

Frontend: banner rojo en Panel cuando haya alertas activas.


---

### 5ï¸âƒ£ Estabilidad (comparador y eventos crÃ­ticos)


Crea vista StabilitySessions.tsx con:

MÃ©tricas LTR/SSF/DRS

Timeline de eventos crÃ­ticos (color por severidad)

Comparador de sesiones (solo estabilidad)

BotÃ³n Exportar PDF


---

### 6ï¸âƒ£ TelemetrÃ­a â€“ alarmas configurables


Crea motor de alarmas en backend:
Tabla telemetry_alerts con campos (variable, operador, umbral, duraciÃ³n, severidad).
Endpoint para crear/editar/eliminar.
Frontend: panel CRUD de alarmas con preview de condiciÃ³n.


---

### 7ï¸âƒ£ ExportaciÃ³n PDF unificada


Genera mÃ³dulo /backend/src/pdf/reportGenerator.ts que reciba filtros y tipo de informe (Panel, Estabilidad, TelemetrÃ­a, IA).
Plantilla PDF comÃºn con portada + grÃ¡ficos + resumen IA.


---

### 8ï¸âƒ£ Pruebas Playwright


Crea carpeta /tests/e2e/playwright/.
Incluye:

login.spec.ts

filters.spec.ts

heatmap.spec.ts

speedmap.spec.ts

upload.spec.ts

compare.spec.ts
Todos deben usar etiquetas @P0 / @P1.


---

### 9ï¸âƒ£ Fix perfil/organizaciÃ³n y conexiÃ³n DB


Corrige /api/user/profile: si organizationId es null, devuelve 200 con {org:null, incomplete_profile:true}.
Ajusta prisma generate en Windows.
Verifica DATABASE_URL (Supabase) y agrega healthcheck.


---

## ğŸ§  Recomendaciones para trabajar con Cursor

1. **Nombrar claramente** tus commits con prefijo `[MODULE]`:  
   Ej. `[MAP] heatmap ranking`, `[UPLOAD] missing files alert`.  
2. **Activa el modo de explicaciÃ³n**: Cursor mostrarÃ¡ su razonamiento antes de insertar.  
3. **Usa el comando `/analyze`** antes de aceptar grandes cambios â†’ revisa imports y dependencias.  
4. **Valida con Lyra** los *prompts optimizados* antes de usarlos (garantiza consistencia).

---

## ğŸš€ Siguiente paso sugerido
Â¿Quieres que te prepare el archivo `.cursor/rules.md` completo (plantilla oficial para que Cursor entienda los mÃ³dulos, restricciones y estilo de cÃ³digo del proyecto)?  
Ese archivo harÃ­a que **todas las sugerencias automÃ¡ticas de Cursor respeten las reglas StabilSafe V2** (sin scroll, modularidad, roles, etc.).  

Puedo generarlo Ã­ntegro en el siguiente mensaje. Â¿Deseas que lo cree?

TÃº dijiste:
Quiero que lo generes integro
ChatGPT Plus

Perfecto âœ…
Voy a generarte el archivo .cursor/rules.md completo y optimizado para el proyecto Doback / StabilSafe V2, adaptado al entorno de Cursor AI.

Este archivo define las reglas de desarrollo, los mÃ³dulos, los roles, las convenciones y las validaciones internas que Cursor debe seguir para que todo el equipo trabaje con coherencia total sin romper el flujo modular ni las normas â€œsin scrollâ€.

ğŸ“˜ .cursor/rules.md â€” Reglas Oficiales de Desarrollo

Proyecto: StabilSafe V2 (DobackSoft)
PropÃ³sito: que Cursor AI mantenga la coherencia tÃ©cnica, visual y lÃ³gica del sistema.

ğŸ§  1. VISIÃ“N CENTRAL (INMUTABLE)

El sistema StabilSafe V2 es una plataforma profesional de anÃ¡lisis de estabilidad y telemetrÃ­a vehicular (CAN/GPS) con enfoque en seguridad, riesgo y comportamiento operativo.

DiseÃ±o modular: cada mÃ³dulo independiente, sin desplazamiento vertical (sin scroll).

Interfaz clara y navegable, cada subpÃ¡gina accesible por pestaÃ±as.

SeparaciÃ³n estricta: Estabilidad â‰  TelemetrÃ­a (CAN/GPS).

Flujo general obligatorio:

Subida â†’ AnÃ¡lisis â†’ VisualizaciÃ³n â†’ ComparaciÃ³n â†’ ExportaciÃ³n

ğŸ§© 2. ESTRUCTURA FIJA DE MÃ“DULOS
NÂº	MÃ³dulo	Acceso	DescripciÃ³n
1	Panel de Control	Todos	Resumen visual de mÃ©tricas y accesos rÃ¡pidos
2	Estabilidad	Todos	AnÃ¡lisis LTR/SSF/DRS y eventos crÃ­ticos
3	TelemetrÃ­a (CAN/GPS)	Todos	Mapas, alarmas, rutas y comparadores
4	Inteligencia Artificial (IA)	Todos	AnÃ¡lisis cruzado y generaciÃ³n de informes
5	Base de Conocimiento	Admin	DocumentaciÃ³n y procedimientos internos
6	AdministraciÃ³n	Admin	GestiÃ³n de flotas, usuarios y permisos
7	Perfil de Usuario	Propio	Datos personales, empresa y configuraciÃ³n
âš™ï¸ 3. FUNCIONES OBLIGATORIAS POR MÃ“DULO
ğŸŸ¦ PANEL DE CONTROL

Tarjetas sin scroll con mÃ©tricas:

Horas de conducciÃ³n, km recorridos

Encendidos y % rotativo activo

Tiempos: en parque, fuera de parque, clave 2, clave 5, taller

Total incidencias (G/M/L)

Acciones rÃ¡pidas: aÃ±adir vehÃ­culo, subir datos, comparar, exportar informe.

Filtros: vehÃ­culo(s), fecha, rotativo, clave, severidad, tipo de vÃ­a.

Compatible con exportaciÃ³n PDF.

ğŸŸ¨ ESTABILIDAD

Solo datos de estabilidad (no CAN/GPS).

MÃ©tricas: LTR, SSF, DRS.

Eventos crÃ­ticos con colores (G/M/L).

GrÃ¡fica principal configurable.

Comparador solo entre sesiones de estabilidad.

Exportar PDF de sesiones o comparaciones.

ğŸŸ© TELEMETRÃA (CAN/GPS)

IntegraciÃ³n CAN + GPS.

Mapa obligatorio con puntos GPS por evento (color segÃºn severidad).

Alarmas configurables por variable.

Comparador de sesiones CAN/GPS.

Subida con detecciÃ³n automÃ¡tica de ID.

Capas:

Mapa de calor (eventos/puntos negros)

Mapa de velocidad (por tipo de vÃ­a y rotativo)

Filtros globales aplicados (vehÃ­culos, rotativo, clave, severidad, tipo de vÃ­a).

ğŸŸª INTELIGENCIA ARTIFICIAL

DetecciÃ³n de patrones cruzando estabilidad y telemetrÃ­a.

Generador de informes PDF con anÃ¡lisis explicativo.

Sugerencias de mejora con justificaciÃ³n tÃ©cnica.

âš« BASE DE CONOCIMIENTO

Solo accesible a ADMIN.

Repositorio tÃ©cnico/documental interno.

âš™ï¸ ADMINISTRACIÃ“N

Solo accesible a ADMIN.

GestiÃ³n completa de flotas, vehÃ­culos, geocercas, alarmas globales y usuarios.

ğŸ‘¤ PERFIL DE USUARIO

Solo visible al usuario autenticado.

Permite editar perfil, empresa y preferencias de panel.

ğŸ”’ 4. ROLES Y VISIBILIDAD
Rol	DescripciÃ³n	Acceso
ADMIN	Acceso completo, gestiÃ³n total.	Todos los mÃ³dulos
MANAGER	Usuario cliente. Solo su flota/empresa.	1, 2, 3, 4, 7
ğŸ“ˆ 5. FLUJOS INTERNOS OBLIGATORIOS

Cada proceso debe seguir la cadena:

Subida â†’ AnÃ¡lisis â†’ VisualizaciÃ³n â†’ ComparaciÃ³n â†’ ExportaciÃ³n


Subida: detectar ID del archivo, asociar a vehÃ­culo/sesiÃ³n.

AnÃ¡lisis: validar estructura, descartar duplicados, calcular mÃ©tricas.

VisualizaciÃ³n: mostrar mÃ©tricas, eventos y mapas filtrables.

ComparaciÃ³n: solo entre sesiones del mismo tipo.

ExportaciÃ³n: generar PDF con mÃ©tricas y contexto de filtros.

ğŸ§¾ 6. SUBIDA DE ARCHIVOS Y CONTROL DE INTEGRIDAD

Subida desde formulario o detecciÃ³n en FTP.

ComprobaciÃ³n automÃ¡tica de archivos faltantes (4 esperados por dÃ­a).

Si faltan archivos â†’ alerta automÃ¡tica â€œSubida incompletaâ€.

Validaciones visuales:

ğŸ”´ sin ID

ğŸŸ  duplicado

âšª corrupto

Si vehÃ­culo no existe â†’ ofrecer creaciÃ³n automÃ¡tica.

ğŸ§­ 7. INTERFAZ Y EXPERIENCIA

Sin scroll vertical en ninguna vista.

Dashboard y paneles modulares y personalizables.

Filtros globales visibles y aplicados en tiempo real.

Mapa de calor interactivo con ranking de puntos crÃ­ticos.

Velocidades coloreadas por tipo de vÃ­a y rotativo ON/OFF.

Tooltips explicativos para todas las claves (2, 5, 0).

DiseÃ±o limpio, jerÃ¡rquico y profesional.

ğŸ§® 8. DATOS Y ESTRUCTURA DE BASE

Postgres + PostGIS
Tablas recomendadas:

vehicles, sessions, ingestions, events, speeds_rules, geofences,
alerts, org_users, telemetry_alerts


speeds_rules: configurable por tipo de vÃ­a, rotativo y clave.

events: almacena geom, severidad, rotativo, clave y tipo.

ingestions: controla expected_files, received_files y errores.

ğŸ”” 9. OBSERVABILIDAD Y QA

Framework de tests: Playwright.

Suites mÃ­nimas:

login.spec.ts

filters.spec.ts

heatmap.spec.ts

speedmap.spec.ts

upload.spec.ts

compare.spec.ts

Etiquetas de prioridad:

@P0 = Bloqueante

@P1 = Funcionalidad principal

@P2 = Opcional/Mejora

Health checks automÃ¡ticos: backend y base de datos.

Logs estructurados (nivel INFO/WARN/ERROR).

MÃ©tricas: tiempo de carga de mapas, latencia de ingestiÃ³n, % de alertas completadas.

ğŸ“¤ 10. EXPORTACIÃ“N PDF

Generador comÃºn /backend/src/pdf/reportGenerator.ts.

Plantillas especÃ­ficas por mÃ³dulo.

Contenido mÃ­nimo:

Portada con filtros aplicados

GrÃ¡ficas y mÃ©tricas

Mapas (si aplica)

AnÃ¡lisis IA y resumen ejecutivo

ğŸ§© 11. CONVENCIONES DE CÃ“DIGO

Cada archivo: un componente / mÃ³dulo.

Cambios con formato:

// ... existing code ...
// cambio aquÃ­
// ... existing code ...


Revisar imports y funciones relacionadas antes de editar.

Nombres consistentes con su mÃ³dulo:

PanelStats.tsx, StabilitySessions.tsx, TelemetriaMap.tsx, AIReport.tsx, etc.

Prefijo de commits: [MODULE] descripciÃ³n breve
Ejemplo: [MAP] ranking de puntos negros

ğŸ§  12. GESTIÃ“N DE ERRORES Y ALERTAS

Todos los errores deben tener feedback visual.

Alertas configurables y clasificadas por severidad (INFO/WARN/ERROR).

Eventos crÃ­ticos (G/M/L) con colores en todos los mapas y grÃ¡ficas.

MÃ©trica â€œporcentaje de ingestiÃ³n completa por dÃ­aâ€.

ğŸ§© 13. INTELIGENCIA ARTIFICIAL (IA)

Analiza datos cruzados Estabilidad â†” TelemetrÃ­a.

Identifica patrones anÃ³malos (vuelcos, sobrevelocidades, frenadas bruscas, etc.).

Genera sugerencias y conclusiones interpretables.

Incluye resumen textual en informes PDF.

ğŸ§± 14. MAPAS
Mapa de Calor:

Capa de densidad (heatmap) + clusters (DBSCAN).

Ranking Top N puntos mÃ¡s repetidos.

Click â†’ lista de incidencias en esa zona.

Mapa de Velocidad:

Basado en speeds_rules.

Colores segÃºn banda de exceso.

Filtros rotativo/clave activos.

ğŸ§° 15. CONFIGURACIÃ“N DE PRUEBAS

Cada mÃ³dulo tendrÃ¡ carpeta /tests/e2e/<module>/.

Pruebas unitarias: funciones crÃ­ticas (DTO, cÃ¡lculos de velocidad, clasificaciÃ³n).

RevisiÃ³n automÃ¡tica al commit de cÃ³digo (CI/CD).

ğŸ§‘â€ğŸ’» 16. MODO DE COLABORACIÃ“N EN CURSOR

No ejecutar npm start ni pnpm dev: los entornos ya estÃ¡n activos.

Solo modificar un archivo por turno, agrupando los cambios.

Revisar con /analyze antes de aceptar sugerencias automÃ¡ticas.

Pedir confirmaciÃ³n si el cambio puede afectar a otro mÃ³dulo.

ğŸ§­ 17. ESTILO VISUAL (FRONTEND)

Framework: React + MUI.

Tema oscuro claro intercambiable.

Sin scroll.

Layout con panel lateral de navegaciÃ³n y pestaÃ±as internas.

Mapa a pantalla completa con overlays flotantes (filtros, leyenda, ranking).

ğŸ§© 18. EXTENSIONES Y API EXTERNAS

Radar.com: geocercas (POLYGON)

TomTom API: mapas base y rutas

DGT (tabla de velocidades): referencial editable en speeds_rules.

ğŸ§  19. IA Y RIESGO VEHICULAR

La IA debe poder identificar factores de vuelco, exceso de velocidad, rotativo inactivo en clave 2/5, reincidencia de eventos.

ClasificaciÃ³n automÃ¡tica de sesiones por nivel de riesgo.

âœ… 20. CRITERIOS DE ACEPTACIÃ“N (RESUMEN)

Todos los mÃ³dulos cargan sin scroll.

Los filtros globales afectan todas las vistas.

El mapa de calor y el mapa de velocidad son interactivos y exportables.

El sistema genera alerta diaria si faltan archivos.

El usuario autenticado nunca recibe 404 en /api/user/profile.

Las pruebas @P0 pasan en Playwright.

ğŸ’¡ 21. NOTAS PARA CURSOR

Nunca mezclar datos de estabilidad y CAN/GPS.

Respetar siempre modularidad visual.

Si se detecta ambigÃ¼edad entre mÃ³dulos, pedir confirmaciÃ³n.

Mantener el tono profesional, limpio y explicativo.

Â¿Deseas que te genere ahora el archivo .cursor/prompts.md con todos los prompts tÃ©cnicos preoptimizados (uno por mÃ³dulo + tareas comunes), para que Cursor los tenga listos en su paleta?
Ese archivo permitirÃ­a ejecutar con un clic los comandos tipo:

/prompt MapaCalor o /prompt SubidaIncompleta
y Cursor insertarÃ­a automÃ¡ticamente el esquema base del cÃ³digo.

TÃº dijiste:
Si
ChatGPT Plus

Excelente ğŸ”¥
AquÃ­ tienes el archivo completo .cursor/prompts.md, diseÃ±ado para integrarse perfectamente con el archivo rules.md que ya generamos.

Este documento sirve como catÃ¡logo de comandos inteligentes para Cursor AI, de modo que con solo escribir /prompt <nombre> podrÃ¡s generar estructuras, componentes o controladores completos siguiendo las normas StabilSafe V2.

âš™ï¸ .cursor/prompts.md â€” Prompts tÃ©cnicos preoptimizados

Proyecto: StabilSafe V2 (DobackSoft)
PropÃ³sito: habilitar comandos directos para crear, mantener o validar mÃ³dulos sin romper la arquitectura.

ğŸ§­ ESTRUCTURA GENERAL

Cada bloque puede ejecutarse con:

/prompt <nombre>


o

/prompt <nombre> detalle


para ver su contexto completo antes de escribir el cÃ³digo.

ğŸŸ¦ PANEL DE CONTROL
/prompt PanelBase

Crea el componente principal del Panel de Control (PanelDashboard.tsx) con tarjetas sin scroll:

Horas de conducciÃ³n, Km recorridos

Encendidos de rotativo y % rotativo activo

Tiempos: en parque, fuera de parque, clave 2, clave 5, taller

Total de incidencias (G/M/L)

Acciones rÃ¡pidas: aÃ±adir vehÃ­culo, subir datos, comparar, exportar PDF

Filtros globales conectados

/prompt PanelKPIHooks

Genera hooks React (usePanelKPIs.ts) que reciban datos filtrados desde la API /api/panel/kpis

Calcula totales, medias y porcentajes

Formatea tiempos en HH:MM

Retorna objeto { label, value, unit, tooltip }[]

ğŸŸ¨ ESTABILIDAD
/prompt StabilityBase

Crea StabilitySessions.tsx con:

SelecciÃ³n de sesiÃ³n

VisualizaciÃ³n de LTR, SSF, DRS

Eventos crÃ­ticos coloreados (G/M/L)

Comparador de sesiones (solo estabilidad)

Exportar PDF

/prompt StabilityChart

Componente configurable de grÃ¡fica principal (StabilityChart.tsx)

SelecciÃ³n de mÃ©trica

ConfiguraciÃ³n persistente por usuario

Tooltip y colores por severidad

ğŸŸ© TELEMETRÃA (CAN/GPS)
/prompt TelemetryMap

Crea TelemetryMap.tsx con:

Vista tipo Grafana

Puntos GPS con colores por severidad

Tooltips con rotativo, velocidad y clave

IntegraciÃ³n con filtros globales

/prompt HeatMap

Genera HotspotMap.tsx

Capa heatmap de densidad

Clusters (PostGIS DBSCAN)

Ranking Top N curvas/puntos

Click â†’ lista de incidencias repetidas

BotÃ³n â€œExportar PDFâ€ con filtros activos

/prompt SpeedMap

Crea SpeedMap.tsx

Capa de puntos coloreados segÃºn exceso de velocidad

Datos de /api/telemetry/speedmap

Filtros: rotativo, clave, tipo de vÃ­a

Leyenda visual de bandas de exceso

/prompt TelemetryAlerts

Crea el sistema de alarmas configurables (TelemetryAlerts.tsx + backend)

CRUD de alarmas (variable, operador, umbral, duraciÃ³n, severidad)

Alerta activa si la condiciÃ³n se cumple durante X segundos

VisualizaciÃ³n tipo lista con indicadores de severidad

ğŸŸª INTELIGENCIA ARTIFICIAL
/prompt AIAnalysis

Crea servicio /backend/src/ai/analyzer.ts

Cruza datos de estabilidad y telemetrÃ­a

Detecta patrones de riesgo (vuelco, sobrevelocidad, frenada brusca)

Devuelve JSON con: pattern, severity, explanation, recommendation

/prompt AIReport

Genera AIReport.tsx (frontend) + reportGenerator.ts (backend)

Genera informe PDF con portada, mÃ©tricas, grÃ¡ficas, anÃ¡lisis IA y conclusiones

Exportar desde botÃ³n â€œGenerar informeâ€

âš™ï¸ ADMINISTRACIÃ“N Y BASE DE CONOCIMIENTO
/prompt AdminUsers

Crea panel de usuarios (AdminUsers.tsx) con roles ADMIN / MANAGER

CRUD de usuarios

AsociaciÃ³n a organizaciÃ³n/flota

/prompt AdminGeofences

Crea panel de geocercas (AdminGeofences.tsx)

Mapa con polÃ­gonos de Radar.com

CRUD de geocercas con nombre, tipo y fuente

Sin scroll, pestaÃ±as por categorÃ­a

ğŸ”’ PERFIL
/prompt Profile

Crea ProfilePage.tsx

Muestra datos del usuario y su organizaciÃ³n

Si organizationId es null â†’ mostrar aviso â€œperfil incompletoâ€

Editar empresa y preferencias de panel

ğŸ§¾ SUBIDA DE ARCHIVOS
/prompt UploadPipeline

Backend (/backend/src/upload/pipeline.ts):

Detecta ID del archivo

Asocia a vehÃ­culo y sesiÃ³n

Si faltan archivos â†’ crea alerta â€œSubida incompletaâ€

Registra errores (sin ID, duplicado, corrupto)

EnvÃ­a resultado a /api/upload/status

/prompt UploadPanel

Frontend (UploadPanel.tsx):

VisualizaciÃ³n de subidas con chips de estado

ğŸŸ¢ correcto

ğŸ”´ error

ğŸŸ  pendiente

BotÃ³n â€œForzar reanÃ¡lisisâ€

IntegraciÃ³n con alertas

ğŸŒ FILTROS GLOBALES
/prompt GlobalFilters

Crea GlobalFilters.tsx (React + Zustand/Redux)

Filtros: vehÃ­culo(s), rango de fechas, rotativo, clave, severidad, tipo de vÃ­a

Estado persistente

Evento onFiltersChange (debounce 300 ms)

Sin scroll; visible en todas las vistas

ğŸ§  IA Y RIESGO VEHICULAR
/prompt RiskDetection

Backend (/backend/src/ai/riskDetection.ts)

Calcula nivel de riesgo por sesiÃ³n:
riesgo = f(LTR, SSF, DRS, sobrevelocidades, frenadas, rotativo, clave)

Clasifica: Bajo / Medio / Alto

Devuelve sugerencias de acciÃ³n (texto corto)

ğŸ” OBSERVABILIDAD Y QA
/prompt QASetup

Genera estructura /tests/e2e/playwright/ con:

login.spec.ts

filters.spec.ts

heatmap.spec.ts

speedmap.spec.ts

upload.spec.ts

compare.spec.ts
Incluye etiquetas @P0/@P1/@P2.

/prompt HealthCheck

Crea endpoint /api/health

Comprueba conexiÃ³n DB, Prisma, API externas (Radar/TomTom)

Devuelve {status:"ok", latency, db, external}

âš™ï¸ INFRAESTRUCTURA Y BASE DE DATOS
/prompt FixProfile

Corrige /api/user/profile

Si falta organizationId â†’ devolver {org:null, incomplete_profile:true} (no 404)

AÃ±adir logs estructurados con userId, orgId

/prompt DBInit

Crea script SQL inicial (init_clean.sql)

Crea tablas base: vehicles, sessions, ingestions, events, speeds_rules, geofences, alerts, org_users, telemetry_alerts

Incluye Ã­ndices espaciales para PostGIS

ğŸ§© EXPORTACIÃ“N PDF
/prompt PDFGenerator

Crea /backend/src/pdf/reportGenerator.ts

Usar ReportLab

Plantilla base + secciones por mÃ³dulo

Portada con filtros, grÃ¡ficas, resumen IA

Exportable desde cada vista con un clic

ğŸ§© CONFIGURACIÃ“N DE PRUEBAS UNITARIAS
/prompt UnitTests

Crea /tests/unit/ con pruebas de:

DTO de filtros

CÃ¡lculo de velocidades

ClasificaciÃ³n G/M/L

ConversiÃ³n de tiempos

ğŸ“Š MÃ‰TRICAS Y ALERTAS
/prompt Metrics

Implementa sistema de mÃ©tricas internas:

ingestions_completed_ratio

avg_map_render_time

active_alerts_count

Exporta a Prometheus-compatible endpoint

ğŸ“¦ BACKLOG Y MANTENIMIENTO
/prompt BacklogGenerate

Genera backlog Markdown (tickets P0â€“P2):

TÃ­tulo, descripciÃ³n, DoD, criterios de aceptaciÃ³n, pruebas sugeridas.

Basado en reglas oficiales.

/prompt CheckCompliance

Audita el repositorio actual para verificar cumplimiento con rules.md:

MÃ³dulos presentes

Scroll detectado

Rutas duplicadas

Endpoints fuera de estÃ¡ndar

ğŸ’¡ CONSEJO FINAL PARA USO EN CURSOR

Cada prompt ya estÃ¡ â€œLyra-optimizadoâ€: contiene contexto, propÃ³sito, restricciones y formato correcto para que Cursor genere cÃ³digo limpio y modular.

Puedes probar directamente:

/prompt HeatMap


y Cursor abrirÃ¡ HotspotMap.tsx con estructura inicial y comentarios guÃ­a.

Para editar comportamientos, agrega al final del prompt:

detalle


y Cursor mostrarÃ¡ el contexto expandido sin escribir aÃºn.

Â¿Quieres que te prepare ahora tambiÃ©n el archivo .cursor/context.md con el entorno semÃ¡ntico compartido (nombres de variables, rutas base, convenciones de DTO, endpoints, nomenclatura de eventos, y esquema PostGIS resumido)?
Ese archivo permite que Cursor mantenga coherencia total cuando genera cÃ³digo en diferentes mÃ³dulos.

TÃº dijiste:
pero dame el archivo completo
ChatGPT Plus

Perfecto ğŸ‘Œ
AquÃ­ tienes el archivo completo .cursor/context.md, el tercero y Ãºltimo del conjunto oficial del entorno Doback / StabilSafe V2 (junto con rules.md y prompts.md).

Este documento define todo el contexto semÃ¡ntico y tÃ©cnico que Cursor debe conocer:
nombres de variables, endpoints, rutas, DTOs, esquema base de datos, convenciones de eventos, capas de mapas, etc.
Sirve para que todas las sugerencias automÃ¡ticas sean coherentes y compatibles entre backend, frontend y base de datos.

ğŸ§­ .cursor/context.md â€” Contexto semÃ¡ntico y tÃ©cnico global

Proyecto: StabilSafe V2 (DobackSoft)
PropÃ³sito: proveer a Cursor AI de una referencia tÃ©cnica centralizada
Compatibilidad: rules.md + prompts.md

ğŸ”– 1. IDENTIDAD DEL PROYECTO

Nombre corto: Doback

Nombre funcional: StabilSafe V2

Ãmbito: Plataforma profesional de anÃ¡lisis de estabilidad y telemetrÃ­a vehicular.

Frontend: React + MUI

Backend: Node.js + Express + Prisma

Base de datos: PostgreSQL + PostGIS

Test E2E: Playwright

Infraestructura: Supabase (DB + Auth), Radar.com (geocercas), TomTom (mapas base).

ğŸ“ 2. ESTRUCTURA DE CARPETAS PRINCIPALES
frontend/
 â”œâ”€ src/
 â”‚   â”œâ”€ components/
 â”‚   â”œâ”€ hooks/
 â”‚   â”œâ”€ modules/
 â”‚   â”‚   â”œâ”€ panel/
 â”‚   â”‚   â”œâ”€ stability/
 â”‚   â”‚   â”œâ”€ telemetry/
 â”‚   â”‚   â”œâ”€ ai/
 â”‚   â”‚   â”œâ”€ admin/
 â”‚   â”‚   â”œâ”€ knowledge/
 â”‚   â”‚   â””â”€ profile/
 â”‚   â”œâ”€ store/
 â”‚   â”œâ”€ utils/
 â”‚   â””â”€ tests/
backend/
 â”œâ”€ src/
 â”‚   â”œâ”€ api/
 â”‚   â”œâ”€ dto/
 â”‚   â”œâ”€ services/
 â”‚   â”œâ”€ pdf/
 â”‚   â”œâ”€ ai/
 â”‚   â””â”€ prisma/
 â”‚       â”œâ”€ schema.prisma
 â”‚       â””â”€ sql/
tests/
 â”œâ”€ e2e/
 â””â”€ unit/

ğŸ§© 3. MODELOS DE DATOS PRINCIPALES (Postgres/PostGIS)
1ï¸âƒ£ vehicles
id UUID PRIMARY KEY
org_id UUID
plate TEXT
type TEXT  -- ejemplo: "camiÃ³n", "autobomba"
created_at TIMESTAMP

2ï¸âƒ£ sessions
id UUID PRIMARY KEY
vehicle_id UUID REFERENCES vehicles(id)
kind TEXT CHECK (kind IN ('stability', 'can', 'gps'))
file_id TEXT
session_number INT
started_at TIMESTAMP
ended_at TIMESTAMP
records INT

3ï¸âƒ£ ingestions
id UUID PRIMARY KEY
source TEXT CHECK (source IN ('ftp', 'form'))
vehicle_id UUID REFERENCES vehicles(id)
expected_files INT
received_files INT
status TEXT CHECK (status IN ('pending', 'complete', 'error'))
errors JSONB
created_at TIMESTAMP

4ï¸âƒ£ events
id UUID PRIMARY KEY
session_id UUID REFERENCES sessions(id)
type TEXT  -- ejemplo: "overspeed", "stability_event"
severity TEXT CHECK (severity IN ('G', 'M', 'L'))
rotativo BOOLEAN
clave TEXT
geom GEOMETRY(POINT, 4326)
attributes JSONB
timestamp TIMESTAMP

5ï¸âƒ£ speeds_rules
road_type TEXT
rotativo BOOLEAN
clave TEXT
max_speed INT
PRIMARY KEY (road_type, rotativo, clave)

6ï¸âƒ£ geofences
id UUID PRIMARY KEY
name TEXT
source TEXT CHECK (source IN ('radar', 'manual'))
geom GEOMETRY(POLYGON, 4326)
tags TEXT[]

7ï¸âƒ£ alerts
id UUID PRIMARY KEY
kind TEXT
subject_id UUID
level TEXT CHECK (level IN ('info', 'warn', 'error'))
created_at TIMESTAMP
payload JSONB

8ï¸âƒ£ telemetry_alerts
id UUID PRIMARY KEY
variable TEXT
operator TEXT
threshold NUMERIC
duration_seconds INT
severity TEXT CHECK (severity IN ('info', 'warn', 'error'))
active BOOLEAN

9ï¸âƒ£ org_users
user_id UUID
org_id UUID
role TEXT CHECK (role IN ('ADMIN', 'MANAGER'))
PRIMARY KEY (user_id, org_id)

ğŸ§  4. DATA TRANSFER OBJECTS (DTOs)
FilterDTO
{
  vehicles: string[];
  dateRange: { start: string; end: string };
  rotativo: 'all' | 'on' | 'off';
  clave: ('0' | '2' | '5' | 'other')[];
  severity: ('G' | 'M' | 'L')[];
  roadType: string[];
}

EventDTO
{
  id: string;
  type: string;
  severity: 'G' | 'M' | 'L';
  timestamp: string;
  vehicle: string;
  rotativo: boolean;
  clave: string;
  location: { lat: number; lon: number };
  attributes?: Record<string, any>;
}

SessionSummaryDTO
{
  sessionId: string;
  vehicle: string;
  kind: 'stability' | 'can' | 'gps';
  duration: string;
  eventsCount: number;
  startTime: string;
  endTime: string;
}

ğŸŒ 5. ENDPOINTS BACKEND PRINCIPALES
Endpoint	MÃ©todo	DescripciÃ³n
/api/panel/kpis	GET	Devuelve mÃ©tricas filtradas para el panel
/api/stability/sessions	GET	Lista sesiones de estabilidad
/api/stability/events	GET	Eventos crÃ­ticos de estabilidad
/api/telemetry/heatmap	GET	Coordenadas de incidencias agrupadas
/api/telemetry/speedmap	GET	Puntos con velocidad y exceso calculado
/api/telemetry/alerts	GET/POST	GestiÃ³n de alarmas
/api/upload/status	GET	Estado de subidas diarias
/api/upload	POST	Subida manual de archivos
/api/ai/report	POST	GeneraciÃ³n de informe IA
/api/ai/patterns	GET	AnÃ¡lisis cruzado de datos
/api/pdf/export	POST	Genera informe PDF
/api/health	GET	Health check completo
ğŸ—ºï¸ 6. CAPAS Y MAPAS
Mapa de Calor (HotspotMap)

Fuente: /api/telemetry/heatmap

Capas:

Heatmap de densidad (todos los eventos)

Clusters (por severidad)

Top N ubicaciones con mayor repeticiÃ³n

InteracciÃ³n: click â†’ listado de incidencias

ExportaciÃ³n: PDF con filtros aplicados

Mapa de Velocidad (SpeedMap)

Fuente: /api/telemetry/speedmap

Colores:

Azul â†’ dentro del lÃ­mite

Amarillo â†’ exceso leve

Naranja â†’ exceso medio

Rojo â†’ exceso grave

Filtros: rotativo, clave, tipo de vÃ­a

Leyenda visible: en overlay fijo

ğŸ§© 7. TIPOS DE EVENTOS DEFINIDOS
CÃ³digo	Tipo	DescripciÃ³n
overspeed	TelemetrÃ­a	Exceso de velocidad
stability_event	Estabilidad	Evento crÃ­tico de vuelco o balanceo
brake_hard	TelemetrÃ­a	Frenada brusca
curve_repetition	TelemetrÃ­a	Alta repeticiÃ³n en una misma curva
rotativo_off_key2	Estado	Clave 2 sin rotativo
rotativo_on_key5	Estado	Clave 5 con rotativo
ingestion_missing	Sistema	Archivos faltantes en subida diaria
ğŸ§  8. VARIABLES CLAVE Y CLASIFICACIONES
Campo	Valores	Notas
rotativo	true / false	Sirena encendida (true) o no
clave	0 / 2 / 5 / other	Estados operativos
severity	G / M / L	Grave, Moderada, Leve
roadType	autopista / urbana / rural / tÃºnel / especial	SegÃºn DGT
kind (session)	stability / can / gps	No mezclar stability con otros
role (user)	ADMIN / MANAGER	Define visibilidad
ğŸ” 9. VARIABLES DERIVADAS (CÃLCULOS ESTANDAR)
Nombre	FÃ³rmula	DescripciÃ³n
porcentaje_rotativo_activo	tiempo_con_rotativo / tiempo_fuera_parque * 100	Uso del rotativo fuera del parque
riesgo_estabilidad	f(LTR, SSF, DRS)	Ãndice IA de riesgo
eventos_por_hora	total_eventos / horas_de_conducciÃ³n	Frecuencia de incidencias
exceso_velocidad	velocidad - max_speed(road_type, rotativo, clave)	Margen sobre lÃ­mite
ğŸ§  10. INTERACCIÃ“N ENTRE MÃ“DULOS

Panel â†’ consume KPIs de estabilidad y telemetrÃ­a.

Estabilidad â†’ genera eventos que se cruzan en IA.

TelemetrÃ­a â†’ provee mapas y alarmas.

IA â†’ usa datos de ambos para sugerencias.

PDF â†’ centraliza todo el resumen.

Admin â†’ mantiene configuraciones de reglas, usuarios, flotas.

ğŸ§© 11. CONVENCIONES DE NOMENCLATURA
Tipo	ConvenciÃ³n
Componentes React	PascalCase (HeatMap.tsx, SpeedMap.tsx)
Hooks React	camelCase con prefijo use
Variables globales	snake_case
DTO / Modelos	PascalCase
Endpoints	RESTful /api/<modulo>/<recurso>
Archivos backend	kebab-case (upload-pipeline.ts)
Commits	[MODULE] descripciÃ³n breve
ğŸ§¾ 12. FORMATOS DE INFORMES PDF

Portada: filtros, vehÃ­culo(s), rango temporal.

Cuerpo: mÃ©tricas + grÃ¡ficas.

Mapas: heatmap / velocidad.

AnÃ¡lisis IA: patrones detectados + recomendaciones.

Resumen ejecutivo: texto generado.

ğŸ“¤ 13. ALERTAS Y MÃ‰TRICAS INTERNAS
MÃ©trica	DescripciÃ³n
ingestions_completed_ratio	Porcentaje de subidas completas
avg_map_render_time	Latencia promedio del mapa
events_per_day	Volumen diario de eventos
alerts_active	NÂº de alertas activas
files_missing_today	NÂº de archivos faltantes hoy
ğŸ§© 14. OBSERVABILIDAD

Health check en /api/health

Logs estructurados {level, message, userId, orgId, timestamp}

Alerta diaria si % de ingestiÃ³n < 100

Playwright: smoke tests + P0 filtros/mapas/subidas

ğŸ§  15. CONTEXTO DE IA

Entradas: sesiones de estabilidad y telemetrÃ­a cruzadas.

Salidas: patrones (riesgo alto, reincidencia, sobrevelocidad sistemÃ¡tica).

Campos IA:

pattern_name

confidence

explanation

recommendation

Se usan en /api/ai/report y PDF final.

âš™ï¸ 16. VARIABLES AMBIENTALES (.env)
DATABASE_URL=postgresql://postgres:password@supabasehost:5432/postgres
SUPABASE_KEY=...
RADAR_API_KEY=...
TOMTOM_API_KEY=...
PORT=4000
NODE_ENV=development

ğŸ’¡ 17. REFERENCIAS DE CÃ“DIGO RÃPIDO

Hook global de filtros: useGlobalFilters()

Contexto AI: useAIAnalyzer()

Selector de vehÃ­culo: VehicleSelector.tsx

Componente PDF: ExportButton.tsx

Middleware validaciÃ³n: validateFilters.middleware.ts

âœ… 18. CRITERIOS DE CONSISTENCIA PARA CURSOR

Todos los nombres de mÃ³dulos y archivos deben coincidir con esta estructura.

No crear rutas nuevas sin prefijo /api/<mÃ³dulo>/....

Las sugerencias de Cursor deben mantener DTOs exactos.

Si se genera nuevo evento o variable, aÃ±adir su definiciÃ³n aquÃ­.

Si se crean nuevos mapas, deben incluir:

capa heatmap o cluster

leyenda

exportaciÃ³n PDF.

ğŸ§© 19. PRUEBAS AUTOMÃTICAS MÃNIMAS

filters.spec.ts â†’ aplica filtros globales en todas las vistas.

heatmap.spec.ts â†’ verifica clusters y ranking.

speedmap.spec.ts â†’ verifica bandas de exceso y leyenda.

upload.spec.ts â†’ prueba subida y alerta faltante.

compare.spec.ts â†’ estabilidad/telemetrÃ­a comparadores.

ğŸ§­ 20. OBJETIVO DE ESTE ARCHIVO

Permitir que Cursor AI mantenga coherencia semÃ¡ntica total al generar, analizar o modificar cÃ³digo en cualquier mÃ³dulo del sistema StabilSafe V2, garantizando:

coherencia terminolÃ³gica,

consistencia entre frontend, backend y base,

cumplimiento estricto de las reglas de proyecto.