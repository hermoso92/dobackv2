name: ğŸ›¡ï¸ Guardrails - Architecture Protection

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  guardrails-scan:
    name: Run Guardrails Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“š Install dependencies
        run: |
          npm install -g ts-node typescript
          npm install glob
      
      - name: ğŸ” Run Guardrails Scanners
        id: scan
        run: |
          npx ts-node scripts/guardrails/run-guardrails.ts scan
        continue-on-error: true
      
      - name: ğŸ“Š Upload Scan Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: guardrails-reports
          path: scripts/guardrails/reports/*.json
          retention-days: 30
      
      - name: ğŸ“ Comment PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summaryPath = 'scripts/guardrails/reports/summary.json';
            
            if (!fs.existsSync(summaryPath)) {
              console.log('No summary report found');
              return;
            }
            
            const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
            
            const criticalIcon = summary.passed ? 'âœ…' : 'âŒ';
            const body = `## ${criticalIcon} Guardrails Scan Results
            
            **Status:** ${summary.passed ? 'PASSED âœ…' : 'FAILED âŒ'}
            **Total Violations:** ${summary.totalViolations}
            **Scanned at:** ${summary.timestamp}
            
            ### Results by Scanner
            
            ${summary.results.map(r => {
              const icon = r.passed ? 'âœ…' : (r.severity === 'critical' ? 'ğŸ”´' : r.severity === 'high' ? 'ğŸŸ ' : 'ğŸŸ¡');
              return `${icon} **${r.scanner}** - ${r.violations} violations (${r.severity})`;
            }).join('\n')}
            
            ${summary.totalViolations > 0 ? `
            ### ğŸ”§ Auto-fix Available
            
            Run locally to fix violations:
            \`\`\`bash
            npm run guardrails fix --dry-run  # Preview fixes
            npm run guardrails fix            # Apply fixes
            \`\`\`
            ` : ''}
            
            <details>
            <summary>ğŸ“„ View detailed reports in artifacts</summary>
            
            - console-logs-violations.json
            - hardcoded-urls-violations.json
            - organizationid-violations.json
            - component-size-violations.json
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: âŒ Fail if critical violations found
        if: steps.scan.outcome == 'failure'
        run: |
          echo "::error::Critical guardrails violations detected! Fix violations before merging."
          exit 1

  # Optional: Run fitness function tests
  fitness-functions:
    name: Run Fitness Function Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“š Install dependencies
        run: |
          npm install -g ts-node typescript jest @types/jest
          npm install glob
      
      - name: ğŸ§ª Run Fitness Function Tests
        run: |
          npx jest scripts/guardrails/fitness-functions --config=jest.config.guardrails.js
        continue-on-error: true

