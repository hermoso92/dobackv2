# ğŸš€ CI/CD - DobackSoft
# Ejecuta automÃ¡ticamente cuando subes cÃ³digo a GitHub

name: CI - Build y Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # âœ… Job 1: Verificar Backend
  backend-check:
    name: ğŸ”§ Backend - Build & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependencias Backend
      working-directory: ./backend
      run: npm ci
      
    - name: ğŸ” Lint Backend
      working-directory: ./backend
      run: npm run lint || echo "âš ï¸ Lint no configurado"
      
    - name: ğŸ—ï¸ Build Backend
      working-directory: ./backend
      run: npm run build || echo "âœ… Backend sin build script (JS directo)"

  # âœ… Job 2: Verificar Frontend
  frontend-check:
    name: ğŸ¨ Frontend - Build & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependencias Frontend
      working-directory: ./frontend
      run: npm ci
      
    - name: ğŸ” Lint Frontend
      working-directory: ./frontend
      run: npm run lint
      
    - name: ğŸ—ï¸ Build Frontend
      working-directory: ./frontend
      run: npm run build
      
    - name: ğŸ“Š Verificar tamaÃ±o del bundle
      working-directory: ./frontend
      run: |
        echo "ğŸ“¦ TamaÃ±o del build:"
        du -sh dist/
        du -sh dist/assets/*.js | head -5

  # âœ… Job 3: Tests (si existen)
  tests:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: [backend-check, frontend-check]
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        
    - name: ğŸ“¦ Instalar dependencias raÃ­z
      run: npm ci || echo "No hay package.json en raÃ­z"
      
    - name: ğŸ§ª Ejecutar tests Backend
      working-directory: ./backend
      run: npm test || echo "âš ï¸ No hay tests configurados en backend"
      
    - name: ğŸ§ª Ejecutar tests Frontend
      working-directory: ./frontend
      run: npm test || echo "âš ï¸ No hay tests configurados en frontend"

  # âœ… Job 4: Verificar base de datos
  database-check:
    name: ğŸ—„ï¸ Database Schema
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        
    - name: ğŸ“¦ Instalar Prisma
      working-directory: ./backend
      run: npm ci
      
    - name: ğŸ” Validar Prisma Schema
      working-directory: ./backend
      run: npx prisma validate
      
    - name: ğŸ“‹ Generar cliente Prisma
      working-directory: ./backend
      run: npx prisma generate

  # âœ… Job 5: Reporte final
  report:
    name: ğŸ“Š Reporte CI
    runs-on: ubuntu-latest
    needs: [backend-check, frontend-check, tests, database-check]
    if: always()
    
    steps:
    - name: âœ… CI Completado
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… CI/CD DobackSoft Completado"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”§ Backend: ${{ needs.backend-check.result }}"
        echo "ğŸ¨ Frontend: ${{ needs.frontend-check.result }}"
        echo "ğŸ§ª Tests: ${{ needs.tests.result }}"
        echo "ğŸ—„ï¸ Database: ${{ needs.database-check.result }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

