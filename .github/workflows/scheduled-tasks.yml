# â° Tareas Programadas
# Ejecuta tareas automÃ¡ticas de mantenimiento

name: Scheduled Tasks

on:
  # Ejecutar todos los dÃ­as a las 3 AM
  schedule:
    - cron: '0 3 * * *'
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:

jobs:
  # âœ… Limpieza de logs viejos
  cleanup-logs:
    name: ğŸ§¹ Limpieza de Logs
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ§¹ Identificar logs antiguos
      run: |
        echo "ğŸ” Buscando logs antiguos (>30 dÃ­as)..."
        
        if [ -d "logs" ]; then
          find logs/ -name "*.log" -mtime +30 -type f | tee old-logs.txt
          
          LOG_COUNT=$(cat old-logs.txt | wc -l)
          echo "ğŸ“Š Logs antiguos encontrados: $LOG_COUNT"
          
          if [ $LOG_COUNT -gt 0 ]; then
            echo "âš ï¸ Considera limpiar estos logs manualmente"
          else
            echo "âœ… No hay logs antiguos para limpiar"
          fi
        else
          echo "â„¹ï¸ Directorio logs/ no existe"
        fi

  # âœ… Verificar dependencias desactualizadas
  check-dependencies:
    name: ğŸ“¦ Verificar Dependencias
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ” Backend - Dependencias desactualizadas
      working-directory: ./backend
      run: |
        echo "ğŸ“¦ Verificando dependencias del Backend..."
        npm outdated || echo "Hay paquetes desactualizados"
        
    - name: ğŸ” Frontend - Dependencias desactualizadas
      working-directory: ./frontend
      run: |
        echo "ğŸ“¦ Verificando dependencias del Frontend..."
        npm outdated || echo "Hay paquetes desactualizados"

  # âœ… AnÃ¡lisis de seguridad
  security-audit:
    name: ğŸ”’ AuditorÃ­a de Seguridad
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ”’ Backend - Audit
      working-directory: ./backend
      run: |
        echo "ğŸ”’ Auditando seguridad del Backend..."
        npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilidades encontradas"
        
    - name: ğŸ”’ Frontend - Audit
      working-directory: ./frontend
      run: |
        echo "ğŸ”’ Auditando seguridad del Frontend..."
        npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilidades encontradas"

  # âœ… AnÃ¡lisis de tamaÃ±o del proyecto
  project-stats:
    name: ğŸ“Š EstadÃ­sticas del Proyecto
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Generar estadÃ­sticas
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š ESTADÃSTICAS DOBACKSOFT"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # LÃ­neas de cÃ³digo
        echo "ğŸ“ LÃ­neas de cÃ³digo:"
        echo "  Backend (JS):"
        find backend/ -name "*.js" -type f | xargs wc -l | tail -1
        echo "  Frontend (TS/TSX):"
        find frontend/ -name "*.ts" -o -name "*.tsx" -type f | xargs wc -l | tail -1 || echo "    No hay archivos TS/TSX"
        echo "  Frontend (JSX):"
        find frontend/ -name "*.jsx" -type f | xargs wc -l | tail -1 || echo "    No hay archivos JSX"
        echo ""
        
        # Archivos por tipo
        echo "ğŸ“‚ DistribuciÃ³n de archivos:"
        find . -type f -name "*.*" | sed 's/.*\.//' | sort | uniq -c | sort -rn | head -10
        echo ""
        
        # TamaÃ±o del proyecto
        echo "ğŸ’¾ TamaÃ±o del proyecto:"
        du -sh backend/ frontend/ 2>/dev/null || echo "  Directorios no encontrados"
        echo ""
        
        # Commits recientes
        echo "ğŸ“ˆ Actividad reciente (Ãºltimos 7 dÃ­as):"
        git log --since="7 days ago" --oneline | wc -l | xargs echo "  Commits:"
        echo ""
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # âœ… Resumen de tareas
  summary:
    name: ğŸ“‹ Resumen
    runs-on: ubuntu-latest
    needs: [cleanup-logs, check-dependencies, security-audit, project-stats]
    if: always()
    
    steps:
    - name: ğŸ“Š Reporte final
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â° TAREAS PROGRAMADAS COMPLETADAS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ§¹ Limpieza: ${{ needs.cleanup-logs.result }}"
        echo "ğŸ“¦ Dependencias: ${{ needs.check-dependencies.result }}"
        echo "ğŸ”’ Seguridad: ${{ needs.security-audit.result }}"
        echo "ğŸ“Š EstadÃ­sticas: ${{ needs.project-stats.result }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

