# ğŸ” ValidaciÃ³n de Pull Requests
# Se ejecuta cuando creas o actualizas un PR

name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # âœ… Validar que el PR cumpla estÃ¡ndares
  validate-pr:
    name: ğŸ” Validar PR
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ“ Verificar tÃ­tulo del PR
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "ğŸ“‹ TÃ­tulo del PR: $PR_TITLE"
        
        # Verificar que no estÃ© vacÃ­o
        if [ -z "$PR_TITLE" ]; then
          echo "âŒ ERROR: El tÃ­tulo del PR estÃ¡ vacÃ­o"
          exit 1
        fi
        
        # Verificar longitud mÃ­nima
        if [ ${#PR_TITLE} -lt 10 ]; then
          echo "âš ï¸ ADVERTENCIA: TÃ­tulo muy corto (mÃ­nimo 10 caracteres)"
        fi
        
        echo "âœ… TÃ­tulo vÃ¡lido"
        
    - name: ğŸ“Š Analizar archivos modificados
      run: |
        echo "ğŸ“ Archivos modificados en este PR:"
        git diff --name-only origin/${{ github.base_ref }}...HEAD
        
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
        echo "ğŸ“Š Total de archivos: $CHANGED_FILES"
        
        if [ $CHANGED_FILES -gt 50 ]; then
          echo "âš ï¸ ADVERTENCIA: PR grande ($CHANGED_FILES archivos). Considera dividirlo."
        fi
        
    - name: ğŸš« Verificar archivos prohibidos
      run: |
        echo "ğŸ” Verificando archivos sensibles..."
        
        FORBIDDEN_PATTERNS=(
          "*.env"
          "config.env"
          "*.key"
          "*.pem"
          "*.p12"
          "*password*"
          "*secret*"
        )
        
        FOUND_FORBIDDEN=false
        for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -i "$pattern"; then
            echo "âŒ ERROR: Archivo prohibido detectado: $pattern"
            FOUND_FORBIDDEN=true
          fi
        done
        
        if [ "$FOUND_FORBIDDEN" = true ]; then
          echo "âŒ El PR contiene archivos sensibles. Por favor elimÃ­nalos."
          exit 1
        fi
        
        echo "âœ… No se detectaron archivos prohibidos"

  # âœ… Verificar cÃ³digo duplicado
  check-duplicates:
    name: ğŸ”„ Detectar cÃ³digo duplicado
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ” Buscar console.log (prohibido)
      run: |
        echo "ğŸ” Buscando console.log en el cÃ³digo..."
        
        # Buscar console.log en archivos modificados
        CONSOLE_LOGS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | xargs grep -n "console\.log" 2>/dev/null || true)
        
        if [ -n "$CONSOLE_LOGS" ]; then
          echo "âš ï¸ ADVERTENCIA: Se encontraron console.log:"
          echo "$CONSOLE_LOGS"
          echo ""
          echo "âŒ Por favor usa 'logger' de utils/logger en lugar de console.log"
          # No falla el build, solo advierte
        else
          echo "âœ… No se encontraron console.log"
        fi
        
    - name: ğŸ” Verificar URLs hardcodeadas
      run: |
        echo "ğŸ” Buscando URLs hardcodeadas..."
        
        # Buscar URLs hardcodeadas
        HARDCODED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | xargs grep -n "http://localhost:[0-9]" 2>/dev/null || true)
        
        if [ -n "$HARDCODED" ]; then
          echo "âš ï¸ ADVERTENCIA: URLs hardcodeadas encontradas:"
          echo "$HARDCODED"
          echo ""
          echo "âŒ Por favor usa config/api.ts en lugar de URLs hardcodeadas"
        else
          echo "âœ… No se encontraron URLs hardcodeadas"
        fi

  # âœ… Resumen del PR
  pr-summary:
    name: ğŸ“Š Resumen del PR
    runs-on: ubuntu-latest
    needs: [validate-pr, check-duplicates]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ“Š Generar resumen
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š RESUMEN DEL PULL REQUEST"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“ TÃ­tulo: ${{ github.event.pull_request.title }}"
        echo "ğŸ‘¤ Autor: ${{ github.event.pull_request.user.login }}"
        echo "ğŸ”€ De: ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}"
        echo ""
        
        # EstadÃ­sticas
        ADDED=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= insertions?)' || echo "0")
        DELETED=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= deletions?)' || echo "0")
        FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
        
        echo "ğŸ“Š EstadÃ­sticas:"
        echo "  ğŸ“ Archivos modificados: $FILES"
        echo "  â• LÃ­neas aÃ±adidas: $ADDED"
        echo "  â– LÃ­neas eliminadas: $DELETED"
        echo ""
        
        # Archivos por tipo
        echo "ğŸ“‚ Archivos por extensiÃ³n:"
        git diff --name-only origin/${{ github.base_ref }}...HEAD | sed 's/.*\.//' | sort | uniq -c | sort -rn
        echo ""
        
        echo "âœ… ValidaciÃ³n: ${{ needs.validate-pr.result }}"
        echo "ğŸ” Check duplicados: ${{ needs.check-duplicates.result }}"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

