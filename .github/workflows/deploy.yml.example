# ğŸš€ Deploy AutomÃ¡tico (EJEMPLO - NO ACTIVO)
# Renombrar a deploy.yml para activar
# Configurar Secrets en GitHub antes de usar

name: Deploy to Production

on:
  push:
    branches: [ main ]
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:

# Solo permitir un deploy a la vez
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # âœ… Build
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependencias Backend
      working-directory: ./backend
      run: npm ci
      
    - name: ğŸ“¦ Instalar dependencias Frontend
      working-directory: ./frontend
      run: npm ci
      
    - name: ğŸ—ï¸ Build Frontend
      working-directory: ./frontend
      run: npm run build
      env:
        # Variables de entorno para producciÃ³n
        VITE_API_URL: ${{ secrets.PRODUCTION_API_URL }}
        
    - name: ğŸ“¦ Subir artefacto
      uses: actions/upload-artifact@v4
      with:
        name: production-build
        path: |
          frontend/dist/
          backend/
        retention-days: 7

  # âœ… Deploy Backend
  deploy-backend:
    name: ğŸ”§ Deploy Backend
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: ${{ secrets.BACKEND_URL }}
    
    steps:
    - name: ğŸ“¥ Descargar artefacto
      uses: actions/download-artifact@v4
      with:
        name: production-build
        
    - name: ğŸš€ Deploy a servidor
      run: |
        echo "ğŸš€ Desplegando Backend..."
        # CONFIGURAR: SSH, SCP, Rsync, Docker, etc.
        
        # Ejemplo con SCP:
        # scp -r backend/ user@server:/path/to/app/
        
        # Ejemplo con SSH para reiniciar:
        # ssh user@server "cd /path/to/app && pm2 restart backend"
        
        echo "âš ï¸ Configurar mÃ©todo de deploy segÃºn tu servidor"

  # âœ… Deploy Frontend
  deploy-frontend:
    name: ğŸ¨ Deploy Frontend
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: ${{ secrets.FRONTEND_URL }}
    
    steps:
    - name: ğŸ“¥ Descargar artefacto
      uses: actions/download-artifact@v4
      with:
        name: production-build
        
    - name: ğŸš€ Deploy a servidor
      run: |
        echo "ğŸš€ Desplegando Frontend..."
        # CONFIGURAR: Netlify, Vercel, S3, Nginx, etc.
        
        # Ejemplo con Netlify:
        # npx netlify-cli deploy --prod --dir=frontend/dist
        
        # Ejemplo con S3:
        # aws s3 sync frontend/dist/ s3://your-bucket/ --delete
        
        echo "âš ï¸ Configurar mÃ©todo de deploy segÃºn tu hosting"

  # âœ… Verificar deploy
  verify-deploy:
    name: âœ… Verificar Deploy
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    
    steps:
    - name: ğŸ” Health check Backend
      run: |
        echo "ğŸ” Verificando Backend..."
        # curl -f ${{ secrets.BACKEND_URL }}/health || exit 1
        echo "âš ï¸ Configurar health check"
        
    - name: ğŸ” Health check Frontend
      run: |
        echo "ğŸ” Verificando Frontend..."
        # curl -f ${{ secrets.FRONTEND_URL }} || exit 1
        echo "âš ï¸ Configurar health check"
        
    - name: ğŸ“§ Notificar Ã©xito
      run: |
        echo "âœ… Deploy completado exitosamente"
        # Configurar notificaciÃ³n: Slack, Discord, Email, etc.

  # âœ… Rollback en caso de error
  rollback:
    name: ğŸ”„ Rollback
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: failure()
    
    steps:
    - name: ğŸ”„ Revertir deploy
      run: |
        echo "âŒ Deploy fallÃ³, ejecutando rollback..."
        # Configurar estrategia de rollback
        echo "âš ï¸ Configurar rollback automÃ¡tico"
        
    - name: ğŸ“§ Notificar error
      run: |
        echo "âŒ Deploy fallÃ³ - se ejecutÃ³ rollback"
        # Notificar al equipo

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# CONFIGURACIÃ“N NECESARIA:
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 
# 1. Secrets en GitHub (Settings â†’ Secrets):
#    - PRODUCTION_API_URL
#    - BACKEND_URL
#    - FRONTEND_URL
#    - SSH_PRIVATE_KEY (si usas SSH)
#    - DEPLOY_TOKEN (token de Netlify/Vercel/etc)
#
# 2. Configurar mÃ©todo de deploy:
#    - SSH/SCP para servidor propio
#    - Netlify/Vercel para frontend
#    - Docker Hub para imÃ¡genes
#    - AWS S3/CloudFront
#
# 3. Renombrar archivo:
#    deploy.yml.example â†’ deploy.yml
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

