generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()"))
  name                  String
  apiKey                String                  @unique
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  AdvancedVehicleKPI    AdvancedVehicleKPI[]
  DailyProcessingReport DailyProcessingReport[]
  Event                 Event[]
  FileState             FileState[]
  geofences             Geofence[]
  GeofenceEvent         GeofenceEvent[]
  GeofenceRule          GeofenceRule[]
  GeofenceVehicleState  GeofenceVehicleState[]
  GestorDeEvento        GestorDeEvento[]
  OrganizationConfig    OrganizationConfig?
  parks                 Park[]
  ProcessingEvent       ProcessingEvent[]
  ProcessingReport      ProcessingReport[]
  Report                Report[]
  Session               Session[]
  User                  User[]
  Vehicle               Vehicle[]
  zones                 Zone[]
}

model User {
  id                String              @id @default(dbgenerated("gen_random_uuid()"))
  email             String              @unique
  name              String
  password          String
  organizationId    String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  role              UserRole            @default(USER)
  status            String              @default("ACTIVE")
  GestorDeEvento    GestorDeEvento[]
  InformeGenerado   InformeGenerado[]
  LogAuditoria      LogAuditoria[]
  MaintenanceRecord MaintenanceRecord[]
  Notification      Notification[]
  ProcessingReport  ProcessingReport[]
  Report            Report[]
  Session           Session[]
  SessionUploadLog  SessionUploadLog[]
  Organization      Organization?       @relation(fields: [organizationId], references: [id])
  UserConfig        UserConfig?
  Vehicle           Vehicle[]
  ZoneAudit         ZoneAudit[]
}

model Park {
  id               String         @id @default(dbgenerated("gen_random_uuid()"))
  name             String
  identifier       String         @unique
  geometry         Json
  organizationId   String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  geometry_postgis String?
  Event            Event[]
  GeofenceRule     GeofenceRule[]
  organization     Organization   @relation(fields: [organizationId], references: [id])
  ParkKPI          ParkKPI[]
  Session          Session[]
  Vehicle          Vehicle[]
  zones            Zone[]
}

model Zone {
  id               String         @id @default(dbgenerated("gen_random_uuid()"))
  name             String
  type             String
  geometry         Json
  organizationId   String
  parkId           String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  geometry_postgis String?
  Event            Event[]
  GeofenceRule     GeofenceRule[]
  Session          Session[]
  organization     Organization   @relation(fields: [organizationId], references: [id])
  park             Park?          @relation(fields: [parkId], references: [id])
  ZoneAudit        ZoneAudit[]
}

model Vehicle {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()"))
  name                  String
  model                 String
  licensePlate          String                  @unique
  brand                 String?
  organizationId        String
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  userId                String?
  identifier            String                  @unique
  type                  VehicleType
  status                VehicleStatus           @default(ACTIVE)
  parkId                String?
  active                Boolean                 @default(true)
  AdvancedVehicleKPI    AdvancedVehicleKPI[]
  ArchivoSubido         ArchivoSubido[]
  EjecucionEvento       EjecucionEvento[]
  EventVehicle          EventVehicle[]
  FileState             FileState[]
  GestorDeEventoVehicle GestorDeEventoVehicle[]
  InformeGenerado       InformeGenerado[]
  MaintenanceRecord     MaintenanceRecord[]
  ProcessingEvent       ProcessingEvent[]
  RealtimePosition      RealtimePosition[]
  Session               Session[]
  SugerenciaIA          SugerenciaIA[]
  Organization          Organization            @relation(fields: [organizationId], references: [id])
  Park                  Park?                   @relation(fields: [parkId], references: [id])
  User                  User?                   @relation(fields: [userId], references: [id])
  VehicleConfiguration  VehicleConfiguration?
  VehicleKPI            VehicleKPI[]
}

model Session {
  id                       String                    @id @default(dbgenerated("gen_random_uuid()"))
  vehicleId                String
  userId                   String
  endTime                  DateTime?
  startTime                DateTime
  createdAt                DateTime                  @default(now())
  sequence                 Int
  sessionNumber            Int
  status                   SessionStatus             @default(ACTIVE)
  updatedAt                DateTime
  type                     SessionType               @default(ROUTINE)
  weatherConditions        Json?
  organizationId           String
  parkId                   String?
  zoneId                   String?
  source                   String
  parser_version           Int                       @default(1)
  processing_version       String?                   @default("1.0")
  matched_distance         Float?
  matched_duration         Float?
  matched_geometry         String?
  matched_confidence       Float?
  ArchivoSubido            ArchivoSubido[]
  EjecucionEvento          EjecucionEvento[]
  GpsMeasurement           GpsMeasurement[]
  InformeGenerado          InformeGenerado[]
  RotativoMeasurement      RotativoMeasurement[]
  Organization             Organization              @relation(fields: [organizationId], references: [id])
  Park                     Park?                     @relation(fields: [parkId], references: [id])
  User                     User                      @relation(fields: [userId], references: [id])
  Vehicle                  Vehicle                   @relation(fields: [vehicleId], references: [id])
  Zone                     Zone?                     @relation(fields: [zoneId], references: [id])
  SessionUploadLog         SessionUploadLog[]
  StabilityMeasurement     StabilityMeasurement[]
  SugerenciaIA             SugerenciaIA[]
  stability_events         stability_events[]
  OperationalStateSegments OperationalStateSegment[]
  ProcessingLogs           ProcessingLog[]
}

model Geofence {
  id                               String                 @id @default(dbgenerated("gen_random_uuid()"))
  externalId                       String?                @unique
  name                             String
  description                      String?
  tag                              String?
  type                             GeofenceType           @default(POLYGON)
  mode                             GeofenceMode           @default(CAR)
  enabled                          Boolean                @default(true)
  live                             Boolean                @default(true)
  geometry                         Json
  geometryCenter                   Json?
  geometryRadius                   Float?
  disallowedPrecedingTagSubstrings Json?
  ip                               Json?
  organizationId                   String
  createdAt                        DateTime               @default(now())
  updatedAt                        DateTime               @updatedAt
  organization                     Organization           @relation(fields: [organizationId], references: [id])
  GeofenceEvent                    GeofenceEvent[]
  GeofenceVehicleState             GeofenceVehicleState[]

  @@index([organizationId])
  @@index([externalId])
  @@index([enabled])
}

model Report {
  id             String       @id @default(dbgenerated("gen_random_uuid()"))
  organizationId String
  requestedById  String
  filePath       String?
  sizeBytes      Int?
  params         Json
  status         ReportStatus @default(PENDING)
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  sha256         String?
  Organization   Organization @relation(fields: [organizationId], references: [id])
  User           User         @relation(fields: [requestedById], references: [id])

  @@index([organizationId])
  @@index([status])
}

model AccionDisparada {
  id              String          @id @default(dbgenerated("gen_random_uuid()"))
  ejecucionId     String
  tipoAccion      String
  resultado       String
  ejecutadoEn     DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  EjecucionEvento EjecucionEvento @relation(fields: [ejecucionId], references: [id])
}

model AdvancedVehicleKPI {
  id                                   String       @id @default(dbgenerated("gen_random_uuid()"))
  vehicleId                            String
  date                                 DateTime
  organizationId                       String
  tiempoEnParque                       Int          @default(0)
  tiempoEnTaller                       Int          @default(0)
  tiempoFueraParque                    Int          @default(0)
  tiempoEnZonaSensible                 Int          @default(0)
  tiempoEnParqueConRotativo            Int          @default(0)
  tiempoEnParqueSinRotativo            Int          @default(0)
  tiempoFueraParqueConRotativo         Int          @default(0)
  tiempoFueraParqueSinRotativo         Int          @default(0)
  tiempoEnTallerConRotativo            Int          @default(0)
  tiempoEnTallerSinRotativo            Int          @default(0)
  eventosCriticos                      Int          @default(0)
  eventosPeligrosos                    Int          @default(0)
  eventosModerados                     Int          @default(0)
  eventosLeves                         Int          @default(0)
  eventosCriticosEnParque              Int          @default(0)
  eventosCriticosFueraParque           Int          @default(0)
  eventosCriticosEnTaller              Int          @default(0)
  eventosPeligrososEnParque            Int          @default(0)
  eventosPeligrososFueraParque         Int          @default(0)
  eventosPeligrososEnTaller            Int          @default(0)
  tiempoExcediendoVelocidad            Int          @default(0)
  tiempoExcediendoVelocidadEnParque    Int          @default(0)
  tiempoExcediendoVelocidadFueraParque Int          @default(0)
  tiempoExcediendoVelocidadEnTaller    Int          @default(0)
  maxVelocidadAlcanzada                Decimal      @default(0)
  velocidadPromedio                    Decimal      @default(0)
  excesosVelocidadLeves                Int          @default(0)
  excesosVelocidadModerados            Int          @default(0)
  excesosVelocidadGraves               Int          @default(0)
  excesosVelocidadMuyGraves            Int          @default(0)
  totalPuntosGPS                       Int          @default(0)
  totalTiempo                          Int          @default(0)
  distanciaRecorrida                   Decimal      @default(0)
  tiempoEnMovimiento                   Int          @default(0)
  tiempoDetenido                       Int          @default(0)
  clave2Minutes                        Int          @default(0)
  clave5Minutes                        Int          @default(0)
  outOfParkMinutes                     Int          @default(0)
  timeInWorkshop                       Int          @default(0)
  eventsHigh                           Int          @default(0)
  eventsModerate                       Int          @default(0)
  createdAt                            DateTime     @default(now())
  updatedAt                            DateTime
  calculatedAt                         DateTime     @default(now())
  isValid                              Boolean      @default(true)
  calculationVersion                   String       @default("1.0")
  Organization                         Organization @relation(fields: [organizationId], references: [id])
  Vehicle                              Vehicle      @relation(fields: [vehicleId], references: [id])

  @@unique([vehicleId, date])
  @@index([calculatedAt])
  @@index([date])
  @@index([organizationId, date])
  @@index([vehicleId, date])
}

model ArchivoSubido {
  id            String   @id @default(dbgenerated("gen_random_uuid()"))
  nombre        String
  tipo          String
  sessionId     String?
  vehiculoId    String?
  fechaSubida   DateTime @default(now())
  errores       String?
  extraMetadata Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  Session       Session? @relation(fields: [sessionId], references: [id])
  Vehicle       Vehicle? @relation(fields: [vehiculoId], references: [id])
}

// ❌ ELIMINADO: CanMeasurement (NO HAY DATOS CAN EN EL SISTEMA)

model DailyProcessingReport {
  id                 String       @id @default(dbgenerated("gen_random_uuid()"))
  organizationId     String
  processingDate     DateTime
  totalVehicles      Int
  successfulVehicles Int
  failedVehicles     Int
  totalDataPoints    Int
  status             String
  details            Json?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime
  Organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model ProcessingReport {
  id             String       @id @default(dbgenerated("gen_random_uuid()"))
  userId         String
  organizationId String
  reportType     String
  status         String // PENDING, PROCESSING, COMPLETED, FAILED
  totalFiles     Int          @default(0)
  totalSessions  Int          @default(0)
  totalOmitted   Int          @default(0)
  startTime      DateTime
  endTime        DateTime?
  duration       Int? // en segundos
  errorMessage   String?
  reportData     Json? // datos detallados del reporte
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model EjecucionEvento {
  id              String            @id @default(dbgenerated("gen_random_uuid()"))
  eventId         String
  vehicleId       String
  sessionId       String?
  triggeredAt     DateTime          @default(now())
  data            Json
  displayData     Json
  location        Json?
  status          EventStatus       @default(ACTIVE)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  AccionDisparada AccionDisparada[]
  GestorDeEvento  GestorDeEvento    @relation(fields: [eventId], references: [id])
  Session         Session?          @relation(fields: [sessionId], references: [id])
  Vehicle         Vehicle           @relation(fields: [vehicleId], references: [id])
  InformeGenerado InformeGenerado[]
}

model Event {
  id             String         @id @default(dbgenerated("gen_random_uuid()"))
  type           EventType
  status         EventStatus
  organizationId String
  timestamp      DateTime
  data           Json
  displayData    Json
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  confidence     Float?
  source         String?
  zoneId         String?
  parkId         String?
  Organization   Organization   @relation(fields: [organizationId], references: [id])
  Park           Park?          @relation(fields: [parkId], references: [id])
  Zone           Zone?          @relation(fields: [zoneId], references: [id])
  EventVehicle   EventVehicle[]

  @@index([status])
  @@index([timestamp])
  @@index([type])
  @@index([organizationId, timestamp(sort: Desc)], map: "idx_event_orgid_timestamp")
}

model EventCondition {
  id             String                 @id @default(dbgenerated("gen_random_uuid()"))
  eventId        String
  type           EventConditionType
  variable       String
  operator       EventConditionOperator
  value          Float
  value2         Float?
  unit           String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime
  GestorDeEvento GestorDeEvento         @relation(fields: [eventId], references: [id])
}

model EventVehicle {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  eventId   String
  vehicleId String
  createdAt DateTime @default(now())
  updatedAt DateTime
  Event     Event    @relation(fields: [eventId], references: [id])
  Vehicle   Vehicle  @relation(fields: [vehicleId], references: [id])

  @@unique([eventId, vehicleId])
  @@index([eventId])
  @@index([vehicleId])
}

model EventoVariableVisible {
  id             String         @id @default(dbgenerated("gen_random_uuid()"))
  eventoId       String
  nombre         String
  orden          Int
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  GestorDeEvento GestorDeEvento @relation(fields: [eventoId], references: [id])
}

model FileState {
  id               String       @id @default(dbgenerated("gen_random_uuid()"))
  fileName         String
  filePath         String
  fileHash         String
  fileSize         Int
  vehicleId        String
  organizationId   String
  fileType         String
  processingStatus String
  decodedStatus    String?
  dataPointsCount  Int?
  lastProcessedAt  DateTime?
  processingErrors String[]
  metadata         Json?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime
  Organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Vehicle          Vehicle      @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([fileHash, organizationId])
}

model ProcessingEvent {
  id                  String             @id @default(dbgenerated("gen_random_uuid()"))
  fileName            String
  filePath            String
  fileType            ProcessingFileType
  vehicleId           String
  organizationId      String
  status              ProcessingStatus
  dataPointsProcessed Int?
  processingTime      Int?
  errorMessage        String?
  errorCode           String?
  metadata            Json?
  timestamp           DateTime           @default(now())
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  Organization        Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Vehicle             Vehicle            @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([organizationId, timestamp])
  @@index([vehicleId, timestamp])
  @@index([status, timestamp])
}

model GeofenceEvent {
  id             String              @id @default(dbgenerated("gen_random_uuid()"))
  geofenceId     String
  vehicleId      String
  organizationId String
  type           GeofenceEventType
  status         GeofenceEventStatus @default(ACTIVE)
  timestamp      DateTime
  latitude       Float
  longitude      Float
  speed          Float?
  heading        Float?
  data           Json?
  processed      Boolean             @default(false)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime
  Geofence       Geofence            @relation(fields: [geofenceId], references: [id], onDelete: Cascade)
  Organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([geofenceId])
  @@index([organizationId])
  @@index([status])
  @@index([timestamp])
  @@index([type])
  @@index([vehicleId])
}

model GeofenceRule {
  id             String       @id
  name           String
  description    String?
  organizationId String
  zoneId         String?
  parkId         String?
  conditions     Json         @default("[]")
  actions        Json         @default("[]")
  isActive       Boolean      @default(true)
  priority       Int          @default(1)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Park           Park?        @relation(fields: [parkId], references: [id], onDelete: Cascade)
  Zone           Zone?        @relation(fields: [zoneId], references: [id], onDelete: Cascade)
}

model GeofenceVehicleState {
  id             String       @id @default(dbgenerated("gen_random_uuid()"))
  vehicleId      String
  organizationId String
  geofenceId     String?
  currentZones   String[]     @default([])
  currentParks   String[]     @default([])
  lastUpdate     DateTime     @default(now())
  ruleStates     Json         @default("{}")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Geofence       Geofence?    @relation(fields: [geofenceId], references: [id])
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([vehicleId, organizationId])
}

model GestorDeEvento {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()"))
  name                  String
  description           String?
  type                  EventType
  status                EventStatus             @default(ACTIVE)
  isPredefined          Boolean                 @default(false)
  logicOperator         EventLogicOperator      @default(AND)
  timeWindowStart       DateTime?
  timeWindowEnd         DateTime?
  createdById           String
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  version               String                  @default("1.0.0")
  autoEvaluate          Boolean                 @default(false)
  organizationId        String                  @db.VarChar(255)
  EjecucionEvento       EjecucionEvento[]
  EventCondition        EventCondition[]
  EventoVariableVisible EventoVariableVisible[]
  User                  User                    @relation(fields: [createdById], references: [id])
  Organization          Organization            @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_gestorevento_organization")
  GestorDeEventoVehicle GestorDeEventoVehicle[]
}

model GestorDeEventoVehicle {
  id               String         @id @default(dbgenerated("gen_random_uuid()"))
  gestorDeEventoId String
  vehicleId        String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  GestorDeEvento   GestorDeEvento @relation(fields: [gestorDeEventoId], references: [id])
  Vehicle          Vehicle        @relation(fields: [vehicleId], references: [id])

  @@unique([gestorDeEventoId, vehicleId])
  @@index([gestorDeEventoId])
  @@index([vehicleId])
}

model GpsMeasurement {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  latitude   Float
  longitude  Float
  altitude   Float
  speed      Float
  satellites Int
  quality    String?
  sessionId  String
  createdAt  DateTime @default(now())
  hdop       Float?
  timestamp  DateTime
  updatedAt  DateTime
  fix        String?
  heading    Float?
  accuracy   Float?
  Session    Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([sessionId, timestamp], map: "gpsmeasurement_sessionid_timestamp_unique")
}

model InformeGenerado {
  id                String           @id @default(dbgenerated("gen_random_uuid()"))
  userId            String
  sessionId         String?
  vehicleId         String?
  sugerenciaIAId    String?
  ejecucionEventoId String?
  tipo              ReportType
  formato           ReportFormat
  urlPdf            String
  generadoEn        DateTime         @default(now())
  createdAt         DateTime         @default(now())
  updatedAt         DateTime
  EjecucionEvento   EjecucionEvento? @relation(fields: [ejecucionEventoId], references: [id])
  Session           Session?         @relation(fields: [sessionId], references: [id])
  SugerenciaIA      SugerenciaIA?    @relation(fields: [sugerenciaIAId], references: [id])
  User              User             @relation(fields: [userId], references: [id])
  Vehicle           Vehicle?         @relation(fields: [vehicleId], references: [id])
}

model LogAuditoria {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  userId    String?
  action    String
  entity    String
  entityId  String?
  details   String
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])
}

model MaintenanceRecord {
  id          String              @id @default(dbgenerated("gen_random_uuid()"))
  vehicleId   String
  userId      String?
  tipo        MaintenanceType
  descripcion String
  fecha       DateTime
  kilometraje Float?
  costo       Float?
  estado      MaintenanceStatus   @default(PENDING)
  prioridad   MaintenancePriority @default(MEDIUM)
  notas       String?
  partes      Json?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime
  User        User?               @relation(fields: [userId], references: [id])
  Vehicle     Vehicle             @relation(fields: [vehicleId], references: [id])
}

model Notification {
  id         String              @id @default(dbgenerated("gen_random_uuid()"))
  userId     String
  type       NotificationType
  channel    NotificationChannel
  message    String
  status     NotificationStatus  @default(PENDING)
  sentAt     DateTime?
  receivedAt DateTime?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime
  User       User                @relation(fields: [userId], references: [id])
}

model OrganizationConfig {
  id                   String         @id @default(dbgenerated("gen_random_uuid()"))
  organizationId       String         @unique
  reportSchedule       ReportSchedule @default(MONTHLY)
  notificationSettings Json
  stabilityThresholds  Json
  telemetryThresholds  Json
  createdAt            DateTime       @default(now())
  updatedAt            DateTime
  Organization         Organization   @relation(fields: [organizationId], references: [id])
}

model ParkKPI {
  id                  String   @id @default(dbgenerated("gen_random_uuid()"))
  parkId              String
  date                DateTime
  totalClave2         Int
  totalClave5         Int
  totalEventsHigh     Int
  totalEventsModerate Int
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  Park                Park     @relation(fields: [parkId], references: [id])
}

model QualityReport {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  date      DateTime
  metrics   Json
  createdAt DateTime @default(now())
}

model RealtimePosition {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  vehicleId String
  timestamp DateTime
  lat       Float
  lon       Float
  alt       Float?
  speed     Float?
  hdop      Float?
  source    String
  Vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId, timestamp(sort: Desc)])
  @@index([timestamp])
}

model RotativoMeasurement {
  id        String    @id @default(dbgenerated("gen_random_uuid()"))
  sessionId String
  timestamp DateTime  @db.Timestamp(6)
  state     String
  createdAt DateTime? @default(now()) @db.Timestamp(6)
  updatedAt DateTime? @default(now()) @db.Timestamp(6)
  Session   Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "rotativomeasurement_sessionid_fkey")

  @@unique([sessionId, timestamp], map: "rotativomeasurement_sessionid_timestamp_unique")
  @@index([sessionId])
  @@index([timestamp])
}

model SessionUploadLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  sessionId String
  userId    String
  timestamp DateTime @default(now())
  status    String
  error     String?
  source    String
  Session   Session  @relation(fields: [sessionId], references: [id])
  User      User     @relation(fields: [userId], references: [id])
}

/// Logs de procesamiento para trazabilidad y monitoreo
model ProcessingLog {
  id                      String    @id @default(dbgenerated("gen_random_uuid()"))
  sessionId               String
  parserVersion           Int       @default(2)
  processingVersion       String    @default("1.0")
  configVersion           String    @default("1.0")
  status                  String
  startedAt               DateTime  @default(now())
  finishedAt              DateTime?
  durationMs              Int?
  measurementsProcessed   Int       @default(0)
  eventsGenerated         Int       @default(0)
  filesCount              Int       @default(0)
  hasGpsGeometry          Boolean   @default(false)
  hasStabilityEvents      Boolean   @default(false)
  physicsValidationPassed Boolean   @default(false)
  errorMessage            String?
  warnings                Json?     @default("[]")
  metadata                Json?     @default("{}")
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  Session                 Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([parserVersion])
  @@index([status, createdAt(sort: Desc)])
}

model StabilityMeasurement {
  id                  String   @id @default(dbgenerated("gen_random_uuid()"))
  timestamp           DateTime
  ax                  Float
  ay                  Float
  az                  Float
  gx                  Float
  gy                  Float
  gz                  Float
  roll                Float?
  pitch               Float?
  yaw                 Float?
  timeantwifi         Float?
  sessionId           String
  createdAt           DateTime @default(now())
  isDRSHigh           Boolean  @default(false)
  isLTRCritical       Boolean  @default(false)
  isLateralGForceHigh Boolean  @default(false)
  temperature         Float?
  updatedAt           DateTime
  accmag              Float    @default(0)
  microsds            Float    @default(0)
  si                  Float    @default(0)
  usciclo1            Float    @default(0)
  usciclo2            Float    @default(0)
  usciclo3            Float    @default(0)
  usciclo4            Float    @default(0)
  usciclo5            Float    @default(0)
  usciclo6            Float    @default(0)
  usciclo7            Float    @default(0)
  usciclo8            Float    @default(0)
  Session             Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([sessionId, timestamp], map: "stabilitymeasurement_sessionid_timestamp_unique")
}

model SugerenciaIA {
  id              String            @id @default(dbgenerated("gen_random_uuid()"))
  sessionId       String?
  vehicleId       String?
  tipo            String
  descripcion     String
  sugerencia      String
  generadoEn      DateTime          @default(now())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  InformeGenerado InformeGenerado[]
  Session         Session?          @relation(fields: [sessionId], references: [id])
  Vehicle         Vehicle?          @relation(fields: [vehicleId], references: [id])
}

model UserConfig {
  id                      String   @id @default(dbgenerated("gen_random_uuid()"))
  userId                  String   @unique
  notificationPreferences Json
  reportPreferences       Json
  language                String   @default("es")
  timezone                String   @default("UTC")
  createdAt               DateTime @default(now())
  updatedAt               DateTime
  User                    User     @relation(fields: [userId], references: [id])
}

model VehicleConfiguration {
  id                  String   @id @default(dbgenerated("gen_random_uuid()"))
  vehicleId           String   @unique
  stabilityThresholds Json
  telemetryThresholds Json
  maintenanceSchedule Json
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  Vehicle             Vehicle  @relation(fields: [vehicleId], references: [id])
}

model VehicleKPI {
  id               String   @id @default(dbgenerated("gen_random_uuid()"))
  vehicleId        String
  date             DateTime
  clave2Minutes    Int
  clave5Minutes    Int
  outOfParkMinutes Int
  eventsHigh       Int
  eventsModerate   Int
  timeInWorkshop   Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime
  Vehicle          Vehicle  @relation(fields: [vehicleId], references: [id])
}

model ZoneAudit {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  zoneId     String
  userId     String
  timestamp  DateTime @default(now())
  changeType String
  oldValue   Json?
  newValue   Json?
  User       User     @relation(fields: [userId], references: [id])
  Zone       Zone     @relation(fields: [zoneId], references: [id])
}

// ❌ ELIMINADO: debug_overspeed (Tabla debug ignorada, sin utilidad)

model stability_events {
  id              String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  session_id      String
  timestamp       DateTime @db.Timestamptz(6)
  lat             Float?
  lon             Float?
  type            String
  severity        String? // Severidad del evento: LEVE, MODERADA, GRAVE, CRÍTICA
  speed           Float? // Velocidad en km/h del evento
  rotativoState   Int? // Estado del rotativo (0=apagado, 1=encendido, 2=clave2, 5=clave5)
  details         Json?
  keyType         Int? // Tipo de clave operacional en el momento del evento (0, 2, 5)
  interpolatedGPS Boolean  @default(false) // Si las coordenadas GPS fueron interpoladas
  Session         Session  @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_session")

  @@index([session_id], map: "idx_stability_events_session")
  @@index([session_id, timestamp(sort: Desc)], map: "idx_stability_events_session_time")
  @@index([timestamp], map: "idx_stability_events_time")
  @@index([type], map: "idx_stability_events_type")
  @@index([speed], map: "idx_stability_events_speed")
  @@index([rotativoState], map: "idx_stability_events_rotativo")
}

/// Tabla para persistir segmentos de claves operacionales (Mandamiento M2)
/// Cada segmento representa un intervalo de tiempo en una clave específica
model OperationalStateSegment {
  id              String   @id @default(dbgenerated("gen_random_uuid()"))
  sessionId       String
  clave           Int // 0, 1, 2, 3, 4, 5
  startTime       DateTime @db.Timestamptz(6)
  endTime         DateTime @db.Timestamptz(6)
  durationSeconds Int
  metadata        Json? // Info adicional (geocerca, rotativo, velocidad promedio)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  Session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sessionId, clave])
  @@index([sessionId, startTime])
  @@map("operational_state_segments")
}

/// Tabla para logging de uso de geocercas (Mandamiento M7)
/// Registra cada llamada a Radar.com o fallback a BD local
model GeofenceUsageLog {
  id             String   @id @default(dbgenerated("gen_random_uuid()"))
  timestamp      DateTime @default(now())
  source         String // 'radar.com' | 'local_db'
  organizationId String
  operation      String // 'getParks' | 'isInGeofence' | 'getZones'
  success        Boolean
  apiCalls       Int      @default(1)
  errorMessage   String?
  createdAt      DateTime @default(now())

  @@index([timestamp])
  @@index([source, timestamp])
  @@index([organizationId])
  @@map("geofence_usage_logs")
}

/// Tabla para persistir violaciones de velocidad (Mandamiento M6)
/// Cada registro es un punto GPS que excede el límite de velocidad
model SpeedViolation {
  id            String   @id @default(dbgenerated("gen_random_uuid()"))
  sessionId     String
  timestamp     DateTime @db.Timestamptz(6)
  lat           Float
  lon           Float
  speed         Float
  speedLimit    Float
  excess        Float
  violationType String // 'correcto' | 'leve' | 'moderada' | 'grave'
  roadType      String // 'urban' | 'interurban' | 'highway'
  rotativoOn    Boolean
  inPark        Boolean
  createdAt     DateTime @default(now())

  @@index([sessionId])
  @@index([sessionId, violationType])
  @@index([timestamp])
  @@index([violationType])
  @@map("speed_violations")
}

enum UserRole {
  ADMIN
  USER
  OPERATOR
  VIEWER
}

enum VehicleStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
  REPAIR
}

enum VehicleType {
  TRUCK
  VAN
  CAR
  BUS
  MOTORCYCLE
  OTHER
  ESCALA
  BRP
  FORESTAL
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  ERROR
  PAUSED
}

enum SessionType {
  ROUTINE
  MAINTENANCE
  EMERGENCY
  TEST
  TRAINING
}

enum ReportType {
  STABILITY
  CAN_GPS
  AI
  EVENT
  COMPARATIVE
  TRENDS
  MAINTENANCE
}

enum ReportStatus {
  PENDING
  READY
  FAILED
}

enum GeofenceType {
  POLYGON
  CIRCLE
  RECTANGLE
}

enum GeofenceMode {
  CAR
  FOOT
  BIKE
  ALL
}

enum EventConditionOperator {
  EQUALS
  NOT_EQUALS
  GREATER_THAN
  LESS_THAN
  GREATER_EQUALS
  LESS_EQUALS
  BETWEEN
  IN_RANGE
}

enum EventConditionType {
  STABILITY
  CAN
  GPS
  COMBINED
}

enum EventLogicOperator {
  AND
  OR
}

enum EventStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  EXPIRED
  ARCHIVED
}

enum EventType {
  STABILITY
  CAN
  COMBINED
  GPS
  SYSTEM
  MAINTENANCE
  CUSTOM
}

enum GeofenceEventStatus {
  ACTIVE
  PROCESSED
  ARCHIVED
}

enum GeofenceEventType {
  ENTER
  EXIT
  INSIDE
  OUTSIDE
}

enum MaintenancePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum MaintenanceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  PREDICTIVE
}

enum NotificationChannel {
  EMAIL
  PUSH
  IN_APP
  SMS
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum NotificationType {
  EVENT
  SYSTEM
  MAINTENANCE
  ALERT
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
  JSON
}

enum ReportSchedule {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum ProcessingFileType {
  ESTABILIDAD
  GPS
  ROTATIVO
}

enum ProcessingStatus {
  STARTED
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}
